{% extends "base.html" %} {% block head %} {{ super() }}
<link href="{{ url_for('static', filename='inspinia/css/plugins/footable/footable.core.css') }}" rel="stylesheet"> {% endblock %} {% block page_content %}
<div class="wrapper wrapper-content">
    <div class="row">
        <!-- <button id='next' class="btn btn-primary"  type="button">Next event</button>
        <button id='prev' class="btn btn-primary"  type="button">Prev event</button> -->
        <div class="col-md-4 col-lg-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>hd</h5>
                    
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>


                <div class="ibox-content">
                    <table data-sort="false" class="footable" data-page-size="50" id='hd' style="width:100%">
                        <tbody>
                            <!-- <tr>
                                <td>index</td>
                                <td>
                                    <div>
                                        <input class="touchspin2" type="text" value="55" name="demo2">
                                    </div>
                                </td>   
                            </tr> -->
                            
                            <tr>
                                <td>index</td>
                                <td id = 'index'></td>
                                <!-- <td >
                                    <div class="input-group">
                                      <input type="text" class="form-control" placeholder="Recipient's username">
                                      <span class="input-group-addon" id="basic-addon2">@example.com</span>
                                    </div>
                                </td> -->
                            </tr>
                            <tr>
                                <td>Crc</td>
                                <td id='crc'></td>
                            </tr>
                            <tr>
                                <td>evnum</td>
                                <td id='evnum'></td>
                            </tr>
                            <tr>
                                <td data-hide="xs">nbuf</td>
                                <td id='nbuf'></td>
                            </tr>
                            <tr>
                                <td>now</td>
                                <td id='now'></td>
                            </tr>
                            <tr>
                                <td>time</td>
                                <td id='time'></td>
                            </tr>
                            <tr>
                                <td>us</td>
                                <td id='us'></td>
                            </tr>
                            <tr>
                                <td>ns</td>
                                <td id='ns'></td>
                            </tr>
                            <tr>
                                <td>Run#</td>
                                <td id='runnum'></td>
                            </tr>
                            <tr>
                                <td>evid</td>
                                <td id='evid'></td>
                            </tr>
                            <tr>
                                <td>priority</td>
                                <td id='priority'></td>
                            </tr>
                            <tr>
                                <td>trigtype</td>
                                <td id='trigtype'></td>
                            </tr>
                            <tr>
                                <td>trignum</td>
                                <td id='trignum'></td>
                            </tr>
                            <tr>
                                <td>trigtime</td>
                                <td id='trigtime'></td>
                            </tr>
                            <tr>
                                <td>l3cnt</td>
                                <td id='l3cnt'></td>
                            </tr>
                            <tr>
                                <td>pps</td>
                                <td id='pps'></td>
                            </tr>
                            <tr>
                                <td>deadtime</td>
                                <td id='deadtime'></td>
                            </tr>
                            <tr>
                                <td>turfword</td>
                                <td id='turfword'></td>
                            </tr>
                            <tr>
                                <td>calib</td>
                                <td id='calib'></td>
                            </tr>
                            <tr>
                                <td>phimask</td>
                                <td id='phimask'></td>
                            </tr>
                            <!-- <tr>
                                <td>phimaskh</td>
                                <td id='phimaskh'></td>
                            </tr> -->
                            <tr>
                                <td>l2mask</td>
                                <td id='l1mask'></td>
                            </tr>
                           <!--  <tr>
                                <td>l2maskh</td>
                                <td id='l1maskh'></td>
                            </tr> -->
                            <tr>
                                <td>l3trigpat</td>
                                <td id='l3trigpat'></td>
                            </tr>
                            <!-- <tr>
                                <td>l3trigpath</td>
                                <td id='l3trigpath'></td>
                            </tr> -->
                            <tr>
                                <td>peakthetabin</td>
                                <td id='peakthetabin'></td>
                            </tr>
                            <tr>
                                <td>imagepeak</td>
                                <td id='imagepeak'></td>
                            </tr>
                            <tr>
                                <td>coherentsumpeak</td>
                                <td id='coherentsumpeak'></td>
                            </tr>
                            <tr>
                                <td>prioritizerstuff</td>
                                <td id='prioritizerstuff'></td>
                            </tr>
                            <tr>
                                <td>c3po</td>
                                <td id='c3po'></td>
                            </tr>
                            <tr>
                                <td>peaktheta</td>
                                <td id='peaktheta'></td>
                            </tr>
                            <tr>
                                <td>peakphi</td>
                                <td id='peakphi'></td>
                            </tr>
                            <tr>
                                <td>peakpol</td>
                                <td id='peakpol'></td>
                            </tr>
                            <!-- <tr>
                                <td>event rate</td>
                                <td id='eventrate'></td>
                            </tr> -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-8 col-lg-8 ">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>waveform</h5>
                    <div class="ibox-tools">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="fa fa-cog"></i>
                        </a>
                        <div class="dropdown-menu dropdown-user " style='width:250px'>
                            <div id="icheckForm" method="post" class="form-vertical">
                                <div class="form-group">
                                    <div class="col-xs-6">
                                        <div class="wv_radio">
                                            <label>
                                                <input type="radio" name="wv" value="mV" /> mV
                                            </label>
                                        </div>
                                        <div class="wv_radio">
                                            <label>
                                                <input type="radio" name="wv" value="FFT" /> FFT
                                            </label>
                                        </div>
                                        <div class="wv_radio">
                                            <label>
                                                <input type="radio" name="wv" value="Power" /> Power
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="icheckForm2" method="post" class="form-vertical">
                                <div class="form-group">
                                    <div class="col-xs-6">
                                        <div class="view_radio">
                                            <label>
                                                <input type="radio" name="view" value="Phi" /> Phi View
                                            </label>
                                        </div>
                                        <div class="view_radio">
                                            <label>
                                                <input type="radio" name="view" value="Surf" /> Surf View
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div>
                                    <div> wv Max
                                        <input class='wv_range' id='wv_max_range' value="50">mV </div>
                                    <div> wv Min
                                        <input class='wv_range' id='wv_min_range' value="-50">mV </div>
                                    <div> FFT Max
                                        <input class='wv_range' id='fft_max_range' value="100"> </div>
                                    <div> FFT Min
                                        <input class='wv_range' id='fft_min_range' value="0"> </div>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div>
                                    <div> # of events
                                        <input id='limit_number' value="10"> 
                                    </div>
                                    <div> length[s]
                                        <input id='time_length' value="1000">
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                    <div class="ibox-content">
                        <table data-sort="false" class="footable" id='wv_head' style="width:100% height:100%" data-page-size="13">
                            <tbody>
                                <th>
                                    <td id = 'evnum'></td>
                                </th>
                            </tbody>
                        </table>
                    </div>
                    <div class="ibox-content" id='wv'>
                        <table data-sort="false" class="footable" id='surfview' style="width:100% height:100%" data-page-size="20">
                            <tbody>
                                <th>
                                    <td>chan 1</td>
                                    <td>chan 2</td>
                                    <td>chan 3</td>
                                    <td>chan 4</td>
                                    <td>chan 5</td>
                                    <td>chan 6</td>
                                    <td>chan 7</td>
                                    <td>chan 8</td>
                                    <td>clock</td>
                                </th>
                                <tr>
                                    <td>surf 1</td>
                                    <td id='wv_0_0'></td>
                                    <td id='wv_0_1'></td>
                                    <td id='wv_0_2'></td>
                                    <td id='wv_0_3'></td>
                                    <td id='wv_0_4'></td>
                                    <td id='wv_0_5'></td>
                                    <td id='wv_0_6'></td>
                                    <td id='wv_0_7'></td>
                                    <td id='wv_0_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 2</td>
                                    <td id='wv_1_0'></td>
                                    <td id='wv_1_1'></td>
                                    <td id='wv_1_2'></td>
                                    <td id='wv_1_3'></td>
                                    <td id='wv_1_4'></td>
                                    <td id='wv_1_5'></td>
                                    <td id='wv_1_6'></td>
                                    <td id='wv_1_7'></td>
                                    <td id='wv_1_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 3</td>
                                    <td id='wv_2_0'></td>
                                    <td id='wv_2_1'></td>
                                    <td id='wv_2_2'></td>
                                    <td id='wv_2_3'></td>
                                    <td id='wv_2_4'></td>
                                    <td id='wv_2_5'></td>
                                    <td id='wv_2_6'></td>
                                    <td id='wv_2_7'></td>
                                    <td id='wv_2_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 4</td>
                                    <td id='wv_3_0'></td>
                                    <td id='wv_3_1'></td>
                                    <td id='wv_3_2'></td>
                                    <td id='wv_3_3'></td>
                                    <td id='wv_3_4'></td>
                                    <td id='wv_3_5'></td>
                                    <td id='wv_3_6'></td>
                                    <td id='wv_3_7'></td>
                                    <td id='wv_3_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 5</td>
                                    <td id='wv_4_0'></td>
                                    <td id='wv_4_1'></td>
                                    <td id='wv_4_2'></td>
                                    <td id='wv_4_3'></td>
                                    <td id='wv_4_4'></td>
                                    <td id='wv_4_5'></td>
                                    <td id='wv_4_6'></td>
                                    <td id='wv_4_7'></td>
                                    <td id='wv_4_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 6</td>
                                    <td id='wv_5_0'></td>
                                    <td id='wv_5_1'></td>
                                    <td id='wv_5_2'></td>
                                    <td id='wv_5_3'></td>
                                    <td id='wv_5_4'></td>
                                    <td id='wv_5_5'></td>
                                    <td id='wv_5_6'></td>
                                    <td id='wv_5_7'></td>
                                    <td id='wv_5_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 7</td>
                                    <td id='wv_6_0'></td>
                                    <td id='wv_6_1'></td>
                                    <td id='wv_6_2'></td>
                                    <td id='wv_6_3'></td>
                                    <td id='wv_6_4'></td>
                                    <td id='wv_6_5'></td>
                                    <td id='wv_6_6'></td>
                                    <td id='wv_6_7'></td>
                                    <td id='wv_6_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 8</td>
                                    <td id='wv_7_0'></td>
                                    <td id='wv_7_1'></td>
                                    <td id='wv_7_2'></td>
                                    <td id='wv_7_3'></td>
                                    <td id='wv_7_4'></td>
                                    <td id='wv_7_5'></td>
                                    <td id='wv_7_6'></td>
                                    <td id='wv_7_7'></td>
                                    <td id='wv_7_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 9</td>
                                    <td id='wv_8_0'></td>
                                    <td id='wv_8_1'></td>
                                    <td id='wv_8_2'></td>
                                    <td id='wv_8_3'></td>
                                    <td id='wv_8_4'></td>
                                    <td id='wv_8_5'></td>
                                    <td id='wv_8_6'></td>
                                    <td id='wv_8_7'></td>
                                    <td id='wv_8_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 10</td>
                                    <td id='wv_9_0'></td>
                                    <td id='wv_9_1'></td>
                                    <td id='wv_9_2'></td>
                                    <td id='wv_9_3'></td>
                                    <td id='wv_9_4'></td>
                                    <td id='wv_9_5'></td>
                                    <td id='wv_9_6'></td>
                                    <td id='wv_9_7'></td>
                                    <td id='wv_9_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 11</td>
                                    <td id='wv_10_0'></td>
                                    <td id='wv_10_1'></td>
                                    <td id='wv_10_2'></td>
                                    <td id='wv_10_3'></td>
                                    <td id='wv_10_4'></td>
                                    <td id='wv_10_5'></td>
                                    <td id='wv_10_6'></td>
                                    <td id='wv_10_7'></td>
                                    <td id='wv_10_8'></td>
                                </tr>
                                <tr>
                                    <td>surf 12</td>
                                    <td id='wv_11_0'></td>
                                    <td id='wv_11_1'></td>
                                    <td id='wv_11_2'></td>
                                    <td id='wv_11_3'></td>
                                    <td id='wv_11_4'></td>
                                    <td id='wv_11_5'></td>
                                    <td id='wv_11_6'></td>
                                    <td id='wv_11_7'></td>
                                    <td id='wv_11_8'></td>
                                </tr>
                            </tbody>
                        </table>
                        <table data-sort="false" class="footable" id='phiview' style="width:100% height:100%" data-page-size="20">
                            <tbody>
                                <th>
                                    <td>phi 1</td>
                                    <td>phi 2</td>
                                    <td>phi 3</td>
                                    <td>phi 4</td>
                                    <td>phi 5</td>
                                    <td>phi 6</td>
                                    <td>phi 7</td>
                                    <td>phi 8</td>
                                </th>
                                <tr>
                                    <td>top_h</td>
                                    <td id='phi_0_0'></td>
                                    <td id='phi_0_1'></td>
                                    <td id='phi_0_2'></td>
                                    <td id='phi_0_3'></td>
                                    <td id='phi_0_4'></td>
                                    <td id='phi_0_5'></td>
                                    <td id='phi_0_6'></td>
                                    <td id='phi_0_7'></td>
                                    <td id='phi_0_c'></td>
                                </tr>
                                <tr>
                                    <td>top_v</td>
                                    <td id='phi_1_0'></td>
                                    <td id='phi_1_1'></td>
                                    <td id='phi_1_2'></td>
                                    <td id='phi_1_3'></td>
                                    <td id='phi_1_4'></td>
                                    <td id='phi_1_5'></td>
                                    <td id='phi_1_6'></td>
                                    <td id='phi_1_7'></td>
                                    <td id='phi_1_c'></td>
                                </tr>
                                <tr>
                                    <td>middle_h</td>
                                    <td id='phi_2_0'></td>
                                    <td id='phi_2_1'></td>
                                    <td id='phi_2_2'></td>
                                    <td id='phi_2_3'></td>
                                    <td id='phi_2_4'></td>
                                    <td id='phi_2_5'></td>
                                    <td id='phi_2_6'></td>
                                    <td id='phi_2_7'></td>
                                    <td id='phi_2_c'></td>
                                </tr>
                                <tr>
                                    <td>middle_v</td>
                                    <td id='phi_3_0'></td>
                                    <td id='phi_3_1'></td>
                                    <td id='phi_3_2'></td>
                                    <td id='phi_3_3'></td>
                                    <td id='phi_3_4'></td>
                                    <td id='phi_3_5'></td>
                                    <td id='phi_3_6'></td>
                                    <td id='phi_3_7'></td>
                                    <td id='phi_3_c'></td>
                                </tr>
                                <tr>
                                    <td>bottom_h</td>
                                    <td id='phi_4_0'></td>
                                    <td id='phi_4_1'></td>
                                    <td id='phi_4_2'></td>
                                    <td id='phi_4_3'></td>
                                    <td id='phi_4_4'></td>
                                    <td id='phi_4_5'></td>
                                    <td id='phi_4_6'></td>
                                    <td id='phi_4_7'></td>
                                    <td id='phi_4_c'></td>
                                </tr>
                                <tr>
                                    <td>bottom_v</td>
                                    <td id='phi_5_0'></td>
                                    <td id='phi_5_1'></td>
                                    <td id='phi_5_2'></td>
                                    <td id='phi_5_3'></td>
                                    <td id='phi_5_4'></td>
                                    <td id='phi_5_5'></td>
                                    <td id='phi_5_6'></td>
                                    <td id='phi_5_7'></td>
                                    <td id='phi_5_c'></td>
                                </tr>
                                <tr>
                                    <td bgcolor="#FFFFFF" style="line-height:10px;" colspan=3>&nbsp;</td>
                                </tr>
                                <tr>
                                    <td bgcolor="#FFFFFF" style="line-height:10px;" colspan=3>&nbsp;</td>
                                </tr>
                                <tr>
                                    <td bgcolor="#FFFFFF" style="line-height:10px;" colspan=3>&nbsp;</td>
                                </tr>
                                <th>
                                    <td>phi 9</td>
                                    <td>phi 10</td>
                                    <td>phi 11</td>
                                    <td>phi 12</td>
                                    <td>phi 13</td>
                                    <td>phi 14</td>
                                    <td>phi 15</td>
                                    <td>phi 16</td>
                                </th>
                                <tr>
                                    <td>top_h</td>
                                    <td id='phi_0_8'></td>
                                    <td id='phi_0_9'></td>
                                    <td id='phi_0_10'></td>
                                    <td id='phi_0_11'></td>
                                    <td id='phi_0_12'></td>
                                    <td id='phi_0_13'></td>
                                    <td id='phi_0_14'></td>
                                    <td id='phi_0_15'></td>
                                    <td id='phi_0_16'></td>
                                </tr>
                                <tr>
                                    <td>top_v</td>
                                    <td id='phi_1_8'></td>
                                    <td id='phi_1_9'></td>
                                    <td id='phi_1_10'></td>
                                    <td id='phi_1_11'></td>
                                    <td id='phi_1_12'></td>
                                    <td id='phi_1_13'></td>
                                    <td id='phi_1_14'></td>
                                    <td id='phi_1_15'></td>
                                    <td id='phi_1_16'></td>
                                </tr>
                                <tr>
                                    <td>middle_h</td>
                                    <td id='phi_2_8'></td>
                                    <td id='phi_2_9'></td>
                                    <td id='phi_2_10'></td>
                                    <td id='phi_2_11'></td>
                                    <td id='phi_2_12'></td>
                                    <td id='phi_2_13'></td>
                                    <td id='phi_2_14'></td>
                                    <td id='phi_2_15'></td>
                                    <td id='phi_2_16'></td>
                                </tr>
                                <tr>
                                    <td>middle_v</td>
                                    <td id='phi_3_8'></td>
                                    <td id='phi_3_9'></td>
                                    <td id='phi_3_10'></td>
                                    <td id='phi_3_11'></td>
                                    <td id='phi_3_12'></td>
                                    <td id='phi_3_13'></td>
                                    <td id='phi_3_14'></td>
                                    <td id='phi_3_15'></td>
                                    <td id='phi_3_16'></td>
                                </tr>
                                <tr>
                                    <td>bottom_h</td>
                                    <td id='phi_4_8'></td>
                                    <td id='phi_4_9'></td>
                                    <td id='phi_4_10'></td>
                                    <td id='phi_4_11'></td>
                                    <td id='phi_4_12'></td>
                                    <td id='phi_4_13'></td>
                                    <td id='phi_4_14'></td>
                                    <td id='phi_4_15'></td>
                                    <td id='phi_4_16'></td>
                                </tr>
                                <tr>
                                    <td>bottom_v</td>
                                    <td id='phi_5_8'></td>
                                    <td id='phi_5_9'></td>
                                    <td id='phi_5_10'></td>
                                    <td id='phi_5_11'></td>
                                    <td id='phi_5_12'></td>
                                    <td id='phi_5_13'></td>
                                    <td id='phi_5_14'></td>
                                    <td id='phi_5_15'></td>
                                    <td id='phi_5_16'></td>
                                </tr>
                            </tbody>
                        </table>
                        
                    </div>
                    <div class="ibox-content">
                        <button type="button" id='average_events' class="btn btn-primary">Events average</button> 
                        <button type="button" id='average_waveforms' class="btn btn-primary">Waveforms average</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="dialog_wv" class='dialog_wv hide'>
    </div>
    <div id="dialog" class='hide'>
        <ul class="nav navbar-top-links">
            <span>Zoom Depth:</span>  <span id = 'zoomIndex'>1/1</span>
            <li><button type="button" id='reset' class="btn btn-success btn-xs">Reset</button> </li>
            <li><button type="button" id='undo' class="btn btn-success btn-xs">Undo</button> </li>
            <li><button type="button" id='redo' class="btn btn-success btn-xs">Redo</button> </li>
            <li><button type="button" id='1hour' class="btn btn-success btn-xs">1Hour</button> </li>
            <li><button type="button" id='6hours' class="btn btn-success btn-xs">6Hours</button> </li>
            <li><button type="button" id='24hours' class="btn btn-success btn-xs">24Hours</button> </li>
        </ul>
        <div id='chart1'></div>
        </br>
        <div class="col-sm-6">
            <div class="form-group">
                <label>Reference UTC</label>
                <input id="reference_time" placeholder="Enter your end time" class="form-control">
            </div>
        </div>
        <div class="col-sm-3">
            <div class="form-group">
                <label>Length(s)</label>
                <input id="length" value="21600" placeholder="Enter the number of seconds" class="form-control">
            </div>
        </div>
        <div class="col-sm-3">
            </br>
            <button id="request" type="button" class="btn btn-primary">Request</button>
        </div>
    </div>
</div>
    {% endblock %} {% block scripts %} {{ super() }}
    <script src="{{ url_for('static', filename='inspinia/js/plugins/footable/footable.all.min.js') }}"></script>
    <script src="{{ url_for('static', filename='inspinia/js/plugins/sparkline/jquery.sparkline.min.js') }}"></script>
    <script src="{{ url_for('static', filename='anita/js/complex_array.js') }}"></script>
    <script src="{{ url_for('static', filename='anita/js/fft.js') }}"></script>
    <script>
    var hd_nbufs = [];
    var hd_evnums = [];
    var hd_times = [];
    var hd_nows = [];
    var i = 0;
    var currentData=null;
    var currentDatamV= null;
    var currentDataFFT= null;
    var currentDataPower= null;
    var datatype = 'mV';
    var dataview = 'Phi';
    var offset = 0;
    var id2phi = {106:0, 102:0,50:1, 46:1,97:2, 93:2,37:3, 41:3,104:4, 100:4,43:5, 39:5,95:6, 91:6,52:7, 48:7,105:8, 101:8,49:9, 45:9,96:10, 92:10,40:11, 36:11,103:12, 99:12,42:13, 38:13,94:14, 90:14,51:15, 47:15,86:0, 82:0,34:1, 30:1,77:2, 73:2,25:3, 21:3,79:4, 75:4,32:5, 28:5,88:6, 84:6,23:7, 19:7,85:8, 81:8,33:9, 29:9,76:10, 72:10,24:11, 20:11,78:12, 74:12,31:13, 27:13,87:14, 83:14,22:15, 18:15,61:0, 57:0,5:1, 1:1,70:2, 66:2,14:3, 10:3,59:4, 55:4,16:5, 12:5,68:6, 64:6,7:7, 3:7,60:8, 56:8,4:9, 0:9,69:10, 65:10,13:11, 9:11,58:12, 54:12,15:13, 11:13,67:14, 63:14,6:15, 2:15};
    var id2pol = {106:'h', 102:'v', 50:'h', 46:'v', 97:'h', 93:'v', 37:'h', 41:'v', 104:'h', 100:'v', 43:'h', 39:'v', 95:'h', 91:'v', 52:'h', 48:'v', 105:'h', 101:'v', 49:'h', 45:'v', 96:'h', 92:'v', 40:'h', 36:'v', 103:'h', 99:'v', 42:'h', 38:'v', 94:'h', 90:'v', 51:'h', 47:'v', 86:'h', 82:'v', 34:'h', 30:'v', 77:'h', 73:'v', 25:'h', 21:'v', 79:'h', 75:'v', 32:'h', 28:'v', 88:'h', 84:'v', 23:'h', 19:'v', 85:'h', 81:'v', 33:'h', 29:'v', 76:'h', 72:'v', 24:'h', 20:'v', 78:'h', 74:'v', 31:'h', 27:'v', 87:'h', 83:'v', 22:'h', 18:'v', 61:'h', 57:'v', 5:'h', 1:'v', 70:'h', 66:'v', 14:'h', 10:'v', 59:'h', 55:'v', 16:'h', 12:'v', 68:'h', 64:'v', 7:'h', 3:'v', 60:'h', 56:'v', 4:'h', 0:'v', 69:'h', 65:'v', 13:'h', 9:'v', 58:'h', 54:'v', 15:'h', 11:'v', 67:'h', 63:'v', 6:'h', 2:'v',};

    var surfchan2phirowpol = {95:'1TH',91:'1TV',45:'2TH',41:'2TV',87:'3TH',83:'3TV',33:'4TH',37:'4TV',93:'5TH',89:'5TV',39:'6TH',35:'6TV',85:'7TH',81:'7TV',47:'8TH',43:'8TV',94:'9TH',90:'9TV',44:'10TH',40:'10TV',86:'11TH',82:'11TV',36:'12TH',32:'12TV',92:'13TH',88:'13TV',38:'14TH',34:'14TV',84:'15TH',80:'15TV',46:'16TH',42:'16TV',77:'1MH',73:'1MV',31:'2MH',27:'2MV',69:'3MH',65:'3MV',23:'4MH',19:'4MV',71:'5MH',67:'5MV',29:'6MH',25:'6MV',79:'7MH',75:'7MV',21:'8MH',17:'8MV',76:'9MH',72:'9MV',30:'10MH',26:'10MV',68:'11MH',64:'11MV',22:'12MH',18:'12MV',70:'13MH',66:'13MV',28:'14MH',24:'14MV',78:'15MH',74:'15MV',20:'16MH',16:'16MV',55:'1BH',51:'1BV',5:'2BH',1:'2BV',63:'3BH',59:'3BV',13:'4BH',9:'4BV',53:'5BH',49:'5BV',15:'6BH',11:'6BV',61:'7BH',57:'7BV',7:'8BH',3:'8BV',54:'9BH',50:'9BV',4:'10BH',0:'10BV',62:'11BH',58:'11BV',12:'12BH',8:'12BV',52:'13BH',48:'13BV',14:'14BH',10:'14BV',60:'15BH',56:'15BV',6:'16BH',2:'16BV'};
    // var surfchan2phirowpol = [95:'1TH',91:'1TV',45:'2TH',41:'2TV',87:'3TH',83:'3TV',33:'4TH',37:'4TV',93:'5TH',89:'5TV',39:'6TH',35:'6TV',85:'7TH',81:'7TV',47:'8TH',43:'8TV',94:'9TH',90:'9TV',44:'10TH',40:'10TV',86:'11TH',82:'11TV',36:'12TH',32:'12TV',92:'13TH',88:'13TV',38:'14TH',34:'14TV',84:'15TH',80:'15TV',46:'16TH',42:'16TV',77:'1MH',73:'1MV',31:'2MH',27:'2MV',69:'3MH',65:'3MV',23:'4MH',19:'4MV',71:'5MH',67:'5MV',29:'6MH',25:'6MV',79:'7MH',75:'7MV',21:'8MH',17:'8MV',76:'9MH',72:'9MV',30:'10MH',26:'10MV',68:'11MH',64:'11MV',22:'12MH',18:'12MV',70:'13MH',66:'13MV',28:'14MH',24:'14MV',78:'15MH',74:'15MV',20:'16MH',16:'16MV',55:'1BH',51:'1BV',5:'2BH',1:'2BV',63:'3BH',59:'3BV',13:'4BH',9:'4BV',53:'5BH',49:'5BV',15:'6BH',11:'6BV',61:'7BH',57:'7BV',7:'8BH',3:'8BV',54:'9BH',50:'9BV',4:'10BH',0:'10BV',62:'11BH',58:'11BV',12:'12BH',8:'12BV',52:'13BH',48:'13BV',14:'14BH',10:'14BV',60:'15BH',56:'15BV',6:'16BH',2:'16BV'];
    var surfMap = [
        [12, 8, 12, 4, 1],
        [6, 6, 6, 2, 2],
        [11, 8, 11, 4, 3],
        [5, 2, 5, 6, 4],
        [12, 6, 12, 2, 5],
        [5, 8, 5, 4, 6],
        [11, 6, 11, 2, 7],
        [6, 8, 6, 4, 8],
        [12, 7, 12, 3, 9],
        [6, 5, 6, 1, 10],
        [11, 7, 11, 3, 11],
        [5, 5, 5, 1, 12],
        [12, 5, 12, 1, 13],
        [5, 7, 5, 3, 14],
        [11, 5, 11, 1, 15],
        [6, 7, 6, 3, 16],
        //top ^
        [10, 6, 10, 2, 1],
        [4, 8, 4, 4, 2],
        [9, 6, 9, 2, 3],
        [3, 8, 3, 4, 4],
        [9, 8, 9, 4, 5],
        [4, 6, 4, 2, 6],
        [10, 8, 10, 4, 7],
        [3, 6, 3, 2, 8],
        [10, 5, 10, 1, 9],
        [4, 7, 4, 3, 10],
        [9, 5, 9, 1, 11],
        [3, 7, 3, 3, 12],
        [9, 7, 9, 3, 13],
        [4, 5, 4, 1, 14],
        [10, 7, 10, 3, 15],
        [3, 5, 3, 1, 16],
        //middle ^
        [7, 8, 7, 4, 1],
        [1, 6, 1, 2, 2],
        [8, 8, 8, 4, 3],
        [2, 6, 2, 2, 4],
        [7, 6, 7, 2, 5],
        [2, 8, 2, 4, 6],
        [8, 6, 8, 2, 7],
        [1, 8, 1, 4, 8],
        [7, 7, 7, 3, 9],
        [1, 5, 1, 1, 10],
        [8, 7, 8, 3, 11],
        [2, 5, 2, 1, 12],
        [7, 5, 7, 1, 13],
        [2, 7, 2, 3, 14],
        [8, 5, 8, 1, 15],
        [1, 7, 1, 3, 16]
    ];

    function resizeWindow() {
        $("canvas").each(function() {
            $(this).attr('style', 'width: 100%');
        });
    }
    function getPeakTheta (peakThetaBin) {
        return 150*(peakThetaBin/256 - 0.5);
    }

    function getPeakPhi (prioritizerstuff) {
        var phiInd2=(prioritizerstuff&0x7ff)>>1;
        var phiInd=(phiInd2&0x3f);
        var phiSector=(phiInd2>>6);
        var phiArrayDeg=[-45,-22.5,0,22.5,45,67.5,90,112.5,135,157.5,180,202.5,225,247.5,270,292.5,315,337.5,0,22.5,45,67.5,90,112.5,135,157.5,180,
                      202.5,225,247.5,270,292.5,315,337.5,
                      0,22.5,45,67.5,90,112.5,135,157.5,180,
                      202.5,225,247.5,270,292.5];

        return phiArrayDeg[phiSector] + 22.5*(phiInd/64 - 0.5);
    }

    function getPeakPol (prioritizerstuff) {
        // vertical : 1. horizontal : 0.
        return prioritizerstuff&0x1;
    }

    function displayData(datatype, name, waveform, maskon, l3trigOn, id) {     
        if (datatype == 'mV') {
            min = Math.min.apply(null, waveform['cal']);
            max = Math.max.apply(null, waveform['cal']);
            range_min = $('#wv_min_range').val()
            range_max = $('#wv_max_range').val()
            currentDatamV[id] = waveform['cal'];
            $(name).attr('values', waveform['cal']).sparkline('html', {
                type: 'line',
                width: '90',
                height: '36 ',
                lineWidth: 0.5,
                lineColor: l3trigOn?'#ff0000':undefined,
                fillColor: l3trigOn?'#f0d0c0':undefined,
                spotColor: false,
                chartRangeMin: range_min,
                chartRangeMax: range_max,
                normalRangeMin: maskon?Math.min(min, range_min):undefined,
                normalRangeMax: maskon?Math.max(max, range_max):undefined,
                drawNormalOnTop: maskon?true:undefined
            });
        } else if (datatype == 'FFT') {
            var fftdata = new complex_array.ComplexArray(260);
            fftdata.map(function(value, i, n) {
                value.real = waveform.cal[i]
            });
            // Array.from(), translate Float32Array into Array.  To make it compatiable with firefox.
            var fft = Array.from(fftdata.FFT().magnitude().slice(1, 130));
            currentDataFFT[id] = fft;
            // console.log(fft);
            // console.log(waveform['cal']);
            min = Math.min.apply(null, fft);
            max = Math.max.apply(null, fft);
            range_min = $('#fft_min_range').val();
            range_max = $('#fft_max_range').val();
            $(name).attr('values', fft).sparkline('html', {
                // $(name).attr('values', fftdata.FFT().magnitude().slice(1, 130)).sparkline('html', {
                type: 'line',
                width: '90',
                height: '36 ',
                lineWidth: 0.5,
                lineColor: l3trigOn?'#ff0000':undefined,
                fillColor: l3trigOn?'#f0d0c0':undefined,
                spotColor: false,
                chartRangeMin: range_min,
                chartRangeMax: range_max,
                normalRangeMin: maskon?Math.min(min, range_min):undefined,
                normalRangeMax: maskon?Math.max(max, range_max):undefined,
            });
        } else if (datatype == 'Power') {
            var power_wv = [];
            for (var i = 0; i < waveform.cal.length; i++) {
                power_wv.push(Math.pow(waveform.cal[i], 2));
            }

            min = 0;
            max = Math.max.apply(null, power_wv);
            range_min = Math.pow($('#wv_min_range').val(), 2);
            range_max = Math.pow($('#wv_max_range').val(), 2);
            console.log(min, max, range_min, range_max);
            currentDataPower[id] = power_wv;

            $(name).attr('values', power_wv).sparkline('html', {
                type: 'line',
                width: '90',
                height: '36 ',
                lineWidth: 0.5,
                lineColor: l3trigOn?'#ff0000':undefined,
                fillColor: l3trigOn?'#f0d0c0':undefined,
                spotColor: false,
                chartRangeMin: range_min,
                chartRangeMax: range_max,
                normalRangeMin: maskon?Math.min(min, range_min):undefined,
                normalRangeMax: maskon?Math.max(max, range_max):undefined,

            });
        }
    }

    function displayDataNone(name, maskon, l3trigOn) {
        $(name).attr('values', 0).sparkline('html', {
            type: 'line',
            width: '90',
            height: '36 ',
            lineWidth: 0.5,
            lineColor: l3trigOn?'#ff0000':undefined,
            fillColor: l3trigOn?'#f0d0c0':undefined,
            spotColor: false,
            normalRangeMin: maskon?-10000:undefined,
            normalRangeMax: maskon?10000:undefined,
            drawNormalOnTop: maskon?true:undefined
        });
    }
    function get_mask(id, l2maskv, l2maskh){
        maskon = false;
        if ((id + 1) % 9 == 0){
            return false;
        }
        if (id2pol[id] == 'v'){
             if ((1 << id2phi[id]) & l2maskv){
                maskon = true;
             }
        }else{
            if ((1 << id2phi[id]) & l2maskh){
                maskon = true;
             }
        }
        return maskon

    }

    function get_l3trig(id, l3trigv, l3trigh){
        l3trigOn = false;
        if ((id + 1) % 9 == 0){
            return false;
        }
        if (id2pol[id] == 'v'){
             if ((1 << id2phi[id]) & l3trigv){
                l3trigOn = true;
             }
        }else{
            if ((1 << id2phi[id]) & l3trigh){
                l3trigOn = true;
             }
        }
        if (l3trigOn){console.log(l3trigOn);}
        
        return l3trigOn
    }

    function updatehtml_hd(nbuf, avgOn = false) {
        if(!nbuf) return;
        $.getJSON('/api/' + ip_db + '/rf/' + nbuf, function(data) {
            $('#hd #index').val(i + 1 + " / " + hd_nbufs.length + "  ");
            $('#hd #crc').html(data.hd.crc);
            $('#hd #nbuf').html(data.hd.nbuf);
            $('#hd #now').html(data.hd.now + " (" + timeConverter(data.hd.now) + ")");
            $('#hd #time').html(data.hd.time + " (" + timeConverter(data.hd.time) + ")");
            $('#hd #us').html(data.hd.us);
            $('#hd #ns').html(data.hd.ns);
            $('#hd #evnum').html(data.hd.evnum);
            $('#hd #runnum').html((data.hd.evid&0xfff00000)>>20);
            $('#hd #evid').html((data.hd.evid&0x000fffff));
            $('#hd #priority').html(hexString(data.hd.priority));
            $('#hd #trigtype').html(data.hd.trigtype);
            $('#hd #trignum').html(data.hd.trignum);
            $('#hd #trigtime').html(data.hd.trigtime);
            $('#hd #l3cnt').html(data.hd.l3cnt);
            $('#hd #pps').html(data.hd.pps);
            $('#hd #deadtime').html(data.hd.deadtime);
            $('#hd #turfword').html(data.hd.turfword);
            $('#hd #calib').html(data.hd.calib);
            $('#hd #phimask').html(byteString(data.hd.phimask));
            // $('#hd #phimaskh').html(byteString(data.hd.phimaskh));
            $('#hd #l1mask').html(byteString(data.hd.l1mask));
            // $('#hd #l1maskh').html(byteString(data.hd.l1maskh));
            $('#hd #l3trigpat').html(byteString(data.hd.l3trigpat));
            // $('#hd #l3trigpath').html(byteString(data.hd.l3trigpath));
            $('#hd #peakthetabin').html(data.hd.peakthetabin);
            $('#hd #imagepeak').html(data.hd.imagepeak);
            $('#hd #coherentsumpeak').html(data.hd.coherentsumpeak);
            $('#hd #prioritizerstuff').html(data.hd.prioritizerstuff);
            $('#hd #c3po').html(data.hd.c3po);
            $('#hd #peaktheta').html(getPeakTheta(data.hd.peakthetabin));
            $('#hd #peakphi').html(getPeakPhi(data.hd.prioritizerstuff));
            $('#hd #peakpol').html(getPeakPol(data.hd.prioritizerstuff));

            l2maskv = data.hd.l1mask;
            l2maskh = data.hd.l1mask;
            l3trigv = data.hd.l3trigpat;
            l3trigh = data.hd.l3trigpat;
            if(avgOn){
                var time_length = $('#time_length').val();
                var limit_number = $('#limit_number').val();
                var endtime = hd_times[i];
                var starttime = endtime -time_length;
                url = '/api/' + ip_db + '/avgwv/' + starttime + '/' + endtime + '/' + limit_number;
            }else{
                url = '/api/' + ip_db + '/wv/' + data.hd.evnum ;
            }
            $.getJSON( url, function(data) {
            // var endtime = data.hd.time
            // var starttime = endtime - 100
            // $.getJSON('/api/' + ip_db + '/avgwv/' + starttime + '/' + endtime + '/10' , function(data) {
                //console.log(data);
                if ('count' in data){
                    $('#wv_head #evnum').html('Start evnum  ' + data.first_evnum + ', End evnum ' + data.evnum + ', count ' + data.count);
                }else{
                    $('#wv_head #evnum').html('evnum  ' + data.evnum);
                }
                
                // $('#wv #time').html(data.time + " (" + timeConverter(data.time) + ")");
                // $('#wv #now').html(data.now + " (" + timeConverter(data.now) + ")");
                var wv_name;
                currentData=data;
                currentDatamV = {};
                currentDataFFT = {};
                currentDataPower = {};
                if (datatype == 'mV' && dataview == 'Surf') {
                    //console.log(datatype);        
                    for (var surf = 0; surf < 12; surf++) {
                        for (var chan = 0; chan < 9; chan++) {
                            wv_name = '#wv_' + surf + '_' + chan;
                            var id = chan + 9 * surf;
                            var waveform = data[id.toString()];
                            // console.log(id + ' '+get_mask(id, l2maskv, l2maskh));
                            maskon = get_mask(id, l2maskv, l2maskh);
                            l3trigOn = get_l3trig(id, l3trigv, l3trigh);
                            if (waveform != undefined) {
                                displayData('mV', wv_name, waveform, maskon, l3trigOn, id);
                            } else {
                                displayDataNone(wv_name, maskon, l3trigOn);
                            };
                        }
                    }
                } else if (datatype == 'FFT' && dataview == 'Surf') {
                    //console.log(datatype);            
                    for (var surf = 0; surf < 12; surf++) {
                        for (var chan = 0; chan < 9; chan++) {
                            wv_name = '#wv_' + surf + '_' + chan;
                            var id = chan + 9 * surf;
                            var waveform = data[id.toString()];
                            //console.log(waveform);
                            maskon = get_mask(id, l2maskv, l2maskh);
                            l3trigOn = get_l3trig(id, l3trigv, l3trigh);
                            if (waveform != undefined) {
                                displayData('FFT', wv_name, waveform, maskon, l3trigOn, id);
                            } else {
                                displayDataNone(wv_name, maskon, l3trigOn);
                            };
                        }

                    }
                } else if (datatype == 'Power' && dataview == 'Surf') {
                    //console.log(datatype);
                    for (var surf = 0; surf < 12; surf++) {
                        for (var chan = 0; chan < 9; chan++) {
                            wv_name = '#wv_' + surf + '_' + chan;
                            var id = chan + 9 * surf;
                            var waveform = data[id.toString()];
                            maskon = get_mask(id, l2maskv, l2maskh);
                            l3trigOn = get_l3trig(id, l3trigv, l3trigh);
                            if (waveform != undefined) {
                                displayData('Power', wv_name, waveform, maskon, l3trigOn, id);
                            } else {
                                displayDataNone(wv_name, maskon, l3trigOn);
                            };
                        }

                    }
                }else if (datatype == 'mV' && dataview == 'Phi') {
                    var phi_h_name;
                    var phi_v_name;
                    var philoc;
                    for (var arrpos = 0; arrpos < 48; arrpos++) {
                        if (arrpos >= 0 && arrpos <= 15) {
                            philoc = 0;
                            philoc2 = 1;
                        } else if (arrpos >= 16 && arrpos <= 31) {
                            philoc = 2;
                            philoc2 = 3;
                        } else if (arrpos >= 32 && arrpos <= 48) {
                            philoc = 4;
                            philoc2 = 5;
                        }
                        var h_surf = surfMap[arrpos][0] - 1;
                        var h_chan = surfMap[arrpos][1] - 1;
                        var v_surf = surfMap[arrpos][2] - 1;
                        var v_chan = surfMap[arrpos][3] - 1;
                        var phiarray = surfMap[arrpos][4] - 1;
                        phi_h_name = '#phi_' + philoc + '_' + phiarray;
                        phi_v_name = '#phi_' + philoc2 + '_' + phiarray;
                        var h_id = h_chan + 9 * h_surf;
                        var v_id = v_chan + 9 * v_surf;
                        var h_waveform = data[h_id.toString()];
                        var v_waveform = data[v_id.toString()];
                        // console.log(h_id + ':' + "h" + ', ');
                        // console.log(v_id + ':' + 'v' + ', ');
                        maskon = get_mask(h_id, l2maskv, l2maskh);
                        l3trigOn = get_l3trig(h_id, l3trigv, l3trigh);
                        if (h_waveform != undefined) {
                            displayData('mV', phi_h_name, h_waveform, maskon, l3trigOn, h_id);
                        } else {
                            displayDataNone(phi_h_name,maskon, l3trigOn);
                        };
                        maskon = get_mask(v_id, l2maskv, l2maskh);
                        l3trigOn = get_l3trig(v_id, l3trigv, l3trigh);
                        if (v_waveform != undefined) {
                            displayData('mV', phi_v_name, v_waveform, maskon, l3trigOn, v_id);
                        } else {
                            displayDataNone(phi_v_name, maskon, l3trigOn);
                        };

                    }
                }else if (datatype == 'FFT' && dataview == 'Phi') {
                    for (var arrpos = 0; arrpos < 48; arrpos++) {
                        if (arrpos >= 0 && arrpos <= 15) {
                            philoc = 0;
                            philoc2 = 1;
                        } else if (arrpos >= 16 && arrpos <= 31) {
                            philoc = 2;
                            philoc2 = 3;
                        } else if (arrpos >= 32 && arrpos <= 48) {
                            philoc = 4;
                            philoc2 = 5;
                        }
                        var h_surf = surfMap[arrpos][0] - 1;
                        var h_chan = surfMap[arrpos][1] - 1;
                        var v_surf = surfMap[arrpos][2] - 1;
                        var v_chan = surfMap[arrpos][3] - 1;
                        var phiarray = surfMap[arrpos][4] - 1;
                        phi_h_name = '#phi_' + philoc + '_' + phiarray;
                        phi_v_name = '#phi_' + philoc2 + '_' + phiarray;
                        var h_id = h_chan + 9 * h_surf;
                        var v_id = v_chan + 9 * v_surf;
                        var h_waveform = data[h_id.toString()];
                        var v_waveform = data[v_id.toString()];
                        maskon = get_mask(h_id, l2maskv, l2maskh);
                        l3trigOn = get_l3trig(h_id, l3trigv, l3trigh);
                        if (h_waveform != undefined) {
                            displayData('FFT', phi_h_name, h_waveform, maskon, l3trigOn, h_id);
                        } else {
                            displayDataNone(phi_h_name, maskon, l3trigOn);
                        };
                        maskon = get_mask(v_id, l2maskv, l2maskh);
                        l3trigOn = get_l3trig(v_id, l3trigv, l3trigh);
                        if (v_waveform != undefined) {
                            displayData('FFT', phi_v_name, v_waveform,maskon, l3trigOn, v_id);
                        } else {
                            displayDataNone(phi_v_name, maskon, l3trigOn);
                        };
                    }
                }else if (datatype == 'Power' && dataview == 'Phi') {
                    //console.log(datatype);      
                    for (var arrpos = 0; arrpos < 48; arrpos++) {
                        if (arrpos >= 0 && arrpos <= 15) {
                            philoc = 0;
                            philoc2 = 1;
                        } else if (arrpos >= 16 && arrpos <= 31) {
                            philoc = 2;
                            philoc2 = 3;
                        } else if (arrpos >= 32 && arrpos <= 48) {
                            philoc = 4;
                            philoc2 = 5;
                        }
                        var h_surf = surfMap[arrpos][0] - 1;
                        var h_chan = surfMap[arrpos][1] - 1;
                        var v_surf = surfMap[arrpos][2] - 1;
                        var v_chan = surfMap[arrpos][3] - 1;
                        var phiarray = surfMap[arrpos][4] - 1;
                        phi_h_name = '#phi_' + philoc + '_' + phiarray;
                        phi_v_name = '#phi_' + philoc2 + '_' + phiarray;
                        var h_id = h_chan + 9 * h_surf;
                        var v_id = v_chan + 9 * v_surf;
                        var h_waveform = data[h_id.toString()];
                        var v_waveform = data[v_id.toString()];
                        maskon = get_mask(h_id, l2maskv, l2maskh);
                        l3trigOn = get_l3trig(h_id, l3trigv, l3trigh);
                        if (h_waveform != undefined) {
                            displayData('Power', phi_h_name, h_waveform, maskon, l3trigOn, h_id);
                        } else {
                            displayDataNone(phi_h_name, maskon, l3trigOn);
                        };
                        maskon = get_mask(v_id, l2maskv, l2maskh);
                        l3trigOn = get_l3trig(v_id, l3trigv, l3trigh);
                        if (v_waveform != undefined) {
                            displayData('Power', phi_v_name, v_waveform, maskon, l3trigOn, v_id);
                        } else {
                            displayDataNone(phi_v_name, maskon, l3trigOn);
                        };
                    }
                    
                }
                resizeWindow();
            });
        });
    }
    $(document).ready(function() {
        $('#navbar_aview').parent().addClass("active");
        $('#label_sync_checkbox').attr('style', 'display:none');
        $('#sync_checkbox').attr('style', 'display:none');
        // change the default to phi view, so hide the surfview.
        $("#surfview").attr('style', 'display:none')

        $(window).on('resize', resizeWindow);

        
        
        $(".touchspin2").TouchSpin({
            min: 0,
            max: 10000,
            boostat: 3,
            maxboostedstep: 200,
            prefix: 'Index',
            postfix: '116750',
            // verticalbuttons: true,
            // buttondown_class: 'btn btn-white',
            // buttonup_class: 'btn btn-white'
        });

        $.jqplot.config.enablePlugins = true;
        $("#wv td[id]").click(function() {
            console.log($(this));
            var waveform_name = $(this).attr('id').split('_');
            if(waveform_name[0]=='wv'){
                surf=parseInt(waveform_name[1]);
                chan=parseInt(waveform_name[2]);
            }else{
                row=parseInt(waveform_name[1]);
                phi=parseInt(waveform_name[2]);
                var antPos= phi + parseInt(row/2) * 16;
                console.log(antPos);
                if (row%2 == 0){
                    surf = surfMap[antPos][0]-1;
                    chan = surfMap[antPos][1]-1;
                }else{
                    surf = surfMap[antPos][2]-1;
                    chan = surfMap[antPos][3]-1;
                }
            }
            var name=datatype+'_'+surf + '_' + chan;
            if ($("#dialog_" + name)){
                $("#dialog_" + name).remove();
            }
            
            var id = chan + 9 * surf;
   
            if ($("#dialog_" + name).length) {
                $("#dialog_" + name).dialog('open');
            } else {
                var $newDialog = $('#dialog_wv').clone();
                $newDialog.attr('id', 'dialog_' + name);
                $newDialog.removeClass('hide');
                chanPlusOne=chan+1;
                surfPlusOne=surf+1;
                if(chanPlusOne == 9){
                    // clock plot does not need phi or row.
                    $newDialog.attr('title', 'chan='+chanPlusOne+' surf='+surfPlusOne);
                }else{
                    $newDialog.attr('title', 'chan='+chanPlusOne+' surf='+surfPlusOne + '  ' + surfchan2phirowpol[surf*8 + chan]);
                }
                
                $newDialog.prepend('<div id="' + "plot_" + name + '"></div>'); 
                $newDialog.dialog({
                    width: 1000,
                    height: 370,
                });
                //  get a copy of data
                console.log(currentData[id.toString()]);
                // var waveform = {cal: [1,2,3,4,5], evnum: 69451483, id: 45, nbuf: -2143125086, now: 1420394514};
                // var waveform = currentData[id.toString()];
                var waveform = jQuery.extend(true, {}, currentData[id.toString()]);
                if (datatype == 'mV'){
                    var line1 = [];
                    for (var i = 0; i < waveform.cal.length; i++) {
                        line1.push([i/2.6, waveform.cal[i]]);
                    }
                    // var line1=waveform.cal;
                } else if (datatype == 'FFT') {
                    var fftdata = new complex_array.ComplexArray(260);
                    fftdata.map(function(value, i, n) {
                        value.real = waveform.cal[i];
                    });
                    // Array.from(), translate Float32Array into Array.  To make it compatiable with firefox.
                    var fft = Array.from(fftdata.FFT().magnitude().slice(1, 130));
                    // var line1=fft;
                    var line1 = [];
                    for (var i = 0; i < fft.length; i++) {
                        line1.push([i*10, fft[i]]);
                    }
                } else if (datatype == 'Power') {
                    var line1 = [];
                    for (var i = 0; i < waveform.cal.length; i++) {
                        line1.push([i/2.6, Math.pow(waveform.cal[i], 2)]);
                    }
                }
                console.log(line1);
                
                var plot1 = $.jqplot('plot_' + name, [line1], {
                    title: 'double click to reset the zoom',
                    // axesDefaults: {
                    //     labelRenderer: $.jqplot.CanvasAxisLabelRenderer
                    // },
                    axes: {
                        xaxis: {
                            // min:0,
                            // max:262,
                            // renderer: $.jqplot.DateAxisRenderer,
                            label: datatype == 'FFT'? 'frequency(MHz)' : 'time(ns)',
                            rendererOptions: {
                                tickRenderer: $.jqplot.CanvasAxisTickRenderer
                            },
                            tickOptions: {
                                formatString: '%d',
                                fontSize: '10pt',
                                fontFamily: 'Tahoma',
                            }
                        },
                        yaxis: {
                            label: datatype == 'Power'? 'Power(mV*mV)': datatype == 'FFT'?'mV*100ns':'Voltage(mV)',
                            renderer: datatype == 'FFT'? $.jqplot.LogAxisRenderer:$.jqplot.CanvasAxisRenderer,
                            rendererOptions: {
                                tickRenderer: $.jqplot.CanvasAxisTickRenderer
                            },
                            tickOptions: {
                                fontSize: '10pt',
                                fontFamily: 'Tahoma',
                            }
                        }
                    },
                    series: [{
                        lineWidth: .5,
                        markerOptions: {
                            size: 3,
                            color: 'blue' 
                        }
                    }],
                    seriesDefaults: {
                        rendererOptions: {
                            smooth: true
                        }
                    },

                    cursor: {
                        zoom: true,
                        looseZoom: true,
                        // showTooltip:true, 
                        followMouse: true,
                        showTooltipOutsideZoom: true,
                        constrainOutsideZoom: false
                    }
                });
                

                $newDialog.dialog({
                    resize: function(event, ui) {
                        $("#plot_" + name).height(Math.max(100, $newDialog.height()*0.95));
                        plot1.replot({
                            resetAxes: true,
                        });
                    }
                });

                $('#next').click(function() {
                    plot1.replot({
                            resetAxes: true,
                        });
                });
            }

            // $("#dialog_" + name).find('button[id="request"]').click(function() {
            //     console.log('click');
            //     var end_time = $newDialog.find('input[id="reference_time"]').val();
            //     var length = $newDialog.find('input[id="length"]').val();
            //     console.log(end_time);
            //     console.log(end_time - length);
            //     $.getJSON('/api/' + ip_db + '/history/' + table_name + '/' + column_name + '/' + (end_time - length) + '/' + end_time, function(data) {
            //         console.log(data.data);
            //         plot1.replot({
            //             data: [data.data]
            //         });
            //     });
            // });   
        });
        $("#hd td[id]").click(function() {
        var column_name = $(this).attr('id');
        var table_name = 'rf';
        var name = table_name + '_' + column_name;
        if (column_name == 'l1mask'){
            name = 'rf_l2mask';
        }
        if (column_name == 'l1maskh'){
            name = 'rf_l2maskh';
        }
        var showline = true;
        if (['trigtype', 'l1mask', 'l1maskh', 'l3trigpat', 'l3trigpath', 'phimask', 'phimaskh'].indexOf(column_name) > -1){
            showline = false;
        }
        // console.log($(this).attr('id'));
        // console.log($(this).closest('.ibox').attr('id'));
        if ($("#dialog_" + name).length) {
            $("#dialog_" + name).dialog('open');
            $("#dialog_" + name).find('input[id="reference_time"]').val(hd_nows[i]);
        } else {
            var $newDialog = $('#dialog').clone();
            $newDialog.attr('id', 'dialog_' + name);
            $newDialog.removeClass('hide');
            $newDialog.attr('title', name);
            $newDialog.prepend('<div id="' + "plot_" + name + '"  class="dialog_plot" ></div>');
            $newDialog.find('input[id="reference_time"]').val(hd_nows[i]);
            $newDialog.dialog({
                width: 600,
                height: 500,
            });
            $newDialog.data('zoomStack', [[hd_nows[i], 21600]]);
            $newDialog.data('zoomStackIndex', 0);
            var line1 = [
            ['2008-09-30', 14]
            ];
            var plot1 = $.jqplot('plot_' + name, [line1], {
                axes: {
                    xaxis: {
                        renderer: $.jqplot.DateAxisRenderer,
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            // formatString: '%M:%S%#N ',
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    },
                    yaxis: {
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    }
                },
                series: [
                    {
                        showLine: showline, 
                        lineWidth: .5,
                        markerOptions: {
                            size: showline?2:4,
                            shadow:false,
                            color: 'blue' 
                        }
                    },
                    {
                        showLine: showline,
                        lineWidth: .5,
                        markerOptions: {
                            size: 2,
                            shadow:false,
                            color: 'grey' 
                        }
                    }
                ],
                cursor: {
                    zoom: true,
                    looseZoom: true,
                    // showTooltip:true, 
                    followMouse: true,
                    showTooltipOutsideZoom: true,
                    constrainOutsideZoom: false
                }
            });
            $("#dialog_" + name).data('plot1', plot1);

            $newDialog.dialog({
                resize: function(event, ui) {
                    $("#plot_" + name).height(Math.max(100, $newDialog.height() - 120));
                    plot1.replot({
                        resetAxes: true,
                    });
                }
            });
        }

        function replotTimeline (table_name, column_name, end_time, length) {
            console.log(end_time, length, 'hi');
            $.getJSON('/api/' + ip_db + '/history/' + table_name + '/' + column_name + '/' + (end_time - length) + '/' + end_time, function(data) {
                // console.log(data);
                if (showline == false){
                    new_data1 = [];
                    new_data2 = [];
                    var step = 1;
                    if (data.data.length > 1000){
                        // step = data.data.length/5000;
                        step = Math.floor(data.data.length/1000);
                    }

                    for (var i = 0; i < data.data.length; i += step){
                        element = data.data[i]
                        for (var bit = 0; bit < 16; bit += 1){
                            if((element[1]>>bit) & 1){
                                new_data1.push([element[0] + timeZoneShift, bit]);
                            }else{
                                new_data2.push([element[0] + timeZoneShift, bit]);
                            }
                        }
                    }
                    datalist = [new_data1, new_data2];
                }else{
                    // datalist = [data.data];
                    new_data = [];
                    var step = 1;
                    if (data.data.length > 50000){
                        // step = data.data.length/5000;
                        step = Math.floor(data.data.length/5000);
                    }
                    if(column_name == 'peaktheta'){
                        for (var i =0; i< data.data.length; i += step){
                            element = data.data[i];
                            new_data.push([element[0] + timeZoneShift, getPeakTheta(element[1])]);
                        }
                    }else if(column_name == 'peakphi'){
                        for (var i =0; i< data.data.length; i += step){
                            element = data.data[i];
                            new_data.push([element[0] + timeZoneShift, getPeakPhi(element[1])]);
                        }
                    }else if(column_name == 'peakpol'){
                        for (var i =0; i< data.data.length; i += step){
                            element = data.data[i];
                            new_data.push([element[0] + timeZoneShift, getPeakPol(element[1])]);
                        }
                    }else{
                        for (var i =0; i< data.data.length; i += step){
                            element = data.data[i];
                            new_data.push([element[0] + timeZoneShift, element[1]]);
                        }
                    }
                    
                    // console.log(data.data.length);
                    datalist = [new_data];
                }
                // console.log(datalist);
                var plot1 = $("#dialog_" + name).data('plot1');
                plot1.replot({
                    data: datalist
                });
            });
        }

        $("#dialog_" + name).on('jqplotZoom', function(ev, gridpos, datapos, plot, cursor){
            end_time = parseInt((plot.axes.xaxis.max - timeZoneShift)/1000);
            length = end_time - parseInt((plot.axes.xaxis.min - timeZoneShift)/1000);
            $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
            $("#dialog_" + name).find('input[id="length"]').val(length);
            var new_index = $(this).data('zoomStackIndex') + 1;
            $(this).data('zoomStackIndex', new_index);
            var new_zoomStack = $(this).data('zoomStack').slice(0, new_index);
            new_zoomStack.push([end_time, length]);
            $(this).data('zoomStack', new_zoomStack);
            console.log(new_index + 1 + '/' + new_zoomStack.length);
            $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
        });

        $("#dialog_" + name + " #reset").click(function() {
            $("#dialog_" + name).data('zoomStackIndex', 0);
            $("#dialog_" + name).data('zoomStack', [[hd_nows[i], 21600]]);
            $("#dialog_" + name).find('input[id="reference_time"]').val(hd_nows[i]);
            $("#dialog_" + name).find('input[id="length"]').val(21600);
            $("#dialog_" + name).find('button[id="request"]').trigger("click");
            $("#dialog_" + name + " #zoomIndex").text('1/1');
        });
        

        $("#dialog_" + name + " #undo").click(function() {
            if ($("#dialog_" + name).data('zoomStack').length > 1){
                var index = $("#dialog_" + name).data('zoomStackIndex') - 1;
                if (index >= 0){
                    $("#dialog_" + name).data('zoomStackIndex', index);
                    var zoomStack = $("#dialog_" + name).data('zoomStack');
                    var zoom = zoomStack[index];
                    var end_time = zoom[0];
                    var length = zoom[1]
                    $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                    $("#dialog_" + name).find('input[id="length"]').val(length);
                    $("#dialog_" + name).find('button[id="request"]').trigger("click");
                    $("#dialog_" + name + " #zoomIndex").text(index + 1 + '/' + zoomStack.length);
                }
            }
        });

        $("#dialog_" + name + " #redo").click(function() {
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex') + 1;
                if (index < stack_length){
                    $("#dialog_" + name).data('zoomStackIndex', index);
                    var zoomStack = $("#dialog_" + name).data('zoomStack');
                    var zoom = zoomStack[index];
                    var end_time = zoom[0];
                    var length = zoom[1]
                    $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                    $("#dialog_" + name).find('input[id="length"]').val(length);
                    $("#dialog_" + name).find('button[id="request"]').trigger("click");
                    $("#dialog_" + name + " #zoomIndex").text(index + 1 + '/' + zoomStack.length);
                }
            }
        });

        $("#dialog_" + name + " #1hour").click(function() {
            console.log('1hour');
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 3600;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name + " #6hours").click(function() {
            console.log('1hour');
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 21600;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name + " #24hours").click(function() {
            console.log('1hour');
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 86400;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name).find('button[id="request"]').click(function() {
            console.log('click');
            var end_time = $newDialog.find('input[id="reference_time"]').val();
            var length = $newDialog.find('input[id="length"]').val();
            // console.log(end_time);
            // console.log(end_time - length);
            replotTimeline(table_name, column_name, end_time, length);
        });

        $("#dialog_" + name).find('button[id="request"]').trigger("click");
    });

        // analysis current waveform, such as average!
        $("#average_waveforms").click(function() {
            var name= 'average_waveforms';
            if ($("#dialog_" + name)){
                $("#dialog_" + name).remove();
            }   
            if ($("#dialog_" + name).length) {
                $("#dialog_" + name).dialog('open');
            } else {
                var $newDialog = $('#dialog').clone();
                $newDialog.attr('id', 'dialog_' + name);
                $newDialog.removeClass('hide');
                $newDialog.attr('title', 'Avergaed Waveform');
                $newDialog.prepend('<div id="' + "plot_" + name + '"></div>'); 
                $newDialog.dialog({
                    width: 1000,
                    height: 370,
                });
               // get the data according to datatype
                var currentDataAny = null;
                if (datatype == 'mV'){
                    currentDataAny = currentDatamV;
                    data_length = 260;
                    x_factor = 2.6;
                }else if (datatype == 'FFT'){
                    currentDataAny = currentDataFFT;
                    data_length = 130;
                    x_factor = 0.1;
                }else if (datatype == 'Power'){
                    currentDataAny = currentDataPower;
                    data_length = 260;
                    x_factor = 2.6;
                }
                console.log(currentDataAny);
                var sum_all = [];
                // initialize zeros
                for (var sample =0; sample <data_length; sample++){
                    sum_all.push(0);
                }
                var number_of_waveforms = 0
                // get the sumation
                
                for (var id = 0; id < 108; id++){
                    // only need the antennas, not clock
                    if (id%9 != 8){
                        if (id in currentDataAny){
                            for (var sample = 0; sample < data_length; sample++){
                                sum_all[sample] += currentDataAny[id][sample];
                            }
                            number_of_waveforms += 1;
                        }
                    }
                }
                // take average now.
                if (number_of_waveforms > 0){
                    var line1 = [];
                    for (var i = 0; i < sum_all.length; i++) {
                        line1.push([i/x_factor, sum_all[i]/number_of_waveforms]);
                    }
                }
                console.log(line1);
                var plot1 = $.jqplot('plot_' + name, [line1], {
                    title: 'double click to reset the zoom',
                    // axesDefaults: {
                    //     labelRenderer: $.jqplot.CanvasAxisLabelRenderer
                    // },
                    axes: {
                        xaxis: {
                            // min:0,
                            // max:262,
                            // renderer: $.jqplot.DateAxisRenderer,
                            label: datatype == 'FFT'? 'frequency(MHz)' : 'time(ns)',
                            rendererOptions: {
                                tickRenderer: $.jqplot.CanvasAxisTickRenderer
                            },
                            tickOptions: {
                                formatString: '%d',
                                fontSize: '10pt',
                                fontFamily: 'Tahoma',
                            }
                        },
                        yaxis: {
                            label: datatype == 'Power'? 'Power(mV*mV)': datatype == 'FFT'?'mV*100ns':'Voltage(mV)',
                            renderer: datatype == 'FFT'? $.jqplot.LogAxisRenderer:$.jqplot.CanvasAxisRenderer,
                            rendererOptions: {
                                tickRenderer: $.jqplot.CanvasAxisTickRenderer
                            },
                            tickOptions: {
                                fontSize: '10pt',
                                fontFamily: 'Tahoma',
                            }
                        }
                    },
                    series: [{
                        lineWidth: .5,
                        markerOptions: {
                            size: 3,
                            color: 'blue' 
                        }
                    }],
                    seriesDefaults: {
                        rendererOptions: {
                            smooth: true
                        }
                    },

                    cursor: {
                        zoom: true,
                        looseZoom: true,
                        // showTooltip:true, 
                        followMouse: true,
                        showTooltipOutsideZoom: true,
                        constrainOutsideZoom: false
                    }
                });
                

                $newDialog.dialog({
                    resize: function(event, ui) {
                        $("#plot_" + name).height(Math.max(100, $newDialog.height()*0.95));
                        plot1.replot({
                            resetAxes: true,
                        });
                    }
                });

                $('#next').click(function() {
                    plot1.replot({
                            resetAxes: true,
                        });
                });
            }

            // $("#dialog_" + name).find('button[id="request"]').click(function() {
            //     console.log('click');
            //     var end_time = $newDialog.find('input[id="reference_time"]').val();
            //     var length = $newDialog.find('input[id="length"]').val();
            //     console.log(end_time);
            //     console.log(end_time - length);
            //     $.getJSON('/api/' + ip_db + '/history/' + table_name + '/' + column_name + '/' + (end_time - length) + '/' + end_time, function(data) {
            //         console.log(data.data);
            //         plot1.replot({
            //             data: [data.data]
            //         });
            //     });
            // });

            
        });
        $('.footable').footable();
        
        var connected = false;
        var sleep_interval = 100 //by default, re-access the database every 2seconds to see if there are any new data comes in.

        $('.wv_range').change(function() {
            updatehtml_hd(hd_nbufs[i]);
        });


        $('#icheckForm').iCheck({
            checkboxClass: 'icheckbox_square-green',
            radioClass: 'iradio_square-green',
        });
        $('input[value=mV]').iCheck('check');

        $('#icheckForm2').iCheck({
            checkboxClass: 'icheckbox_square-green',
            radioClass: 'iradio_square-green',
        });
        $('input[value=Phi]').iCheck('check');

        

        function autoload(offset) {
            $.getJSON('/api/' + ip_db + '/rf/nbufs/' + offset, function(data) {
                console.log('hd api');
                console.log(data);
                
                new_length = data.hd_nbufs.length;
                offset += new_length;
                hd_nbufs = hd_nbufs.concat(data.hd_nbufs);
                hd_evnums = hd_evnums.concat(data.hd_evnums);
                hd_times = hd_times.concat(data.hd_times);
                hd_nows = hd_nows.concat(data.hd_nows);
                $('#hd #index').html(i + 1 + " / " + hd_nbufs.length + "  ");
                $('#connect').removeClass('connect').removeClass('btn-primary').addClass('btn-warning');
                $('#connect').html('Disconnect');
                $('.chosen-select').attr("disabled", true).trigger("chosen:updated");
                connected = true;
                $('#connect').value = 'Disconnect'
                connect.ladda('stop');
                console.log(offset);
                
            }).done(function() {
                setTimeout(function() {
                    if (new_length) {
                        sleep_interval = 100;
                    } else {
                        sleep_interval = Math.min(sleep_interval * 1.2, 60000);
                    }
                    if (connected == true) {
                        autoload(offset);
                    }
                }, sleep_interval);
            });
        }
        function getEventRate() {
            $.getJSON('/api/' + ip_db + '/eventrate/' + '30', function(data) {
                    $('#eventrate').html(' Current Event Rate: ' + data.eventrate + 'Hz');
            });
        }


 


        var connect = $('.ladda-button').ladda();
        $('#connect').click(function() {
            var eventRateTimer ;
            offset = 0;
            hd_nbufs = [];
            hd_evnums = [];
            hd_times = [];
            hd_nows = [];
            i = 0;
            if ($(this).hasClass('connect')) {
                connect.ladda('start');
                $.ajax({
                    url: '/api/connect/' + ip + '/' + db
                }).done(function(response) {
                    if (response == 'success') {
                        console.log('succeed');
                        getEventRate();
                        eventRateTimer = setInterval(function(){ getEventRate() }, 10000);
                        autoload(0);
                        console.log('after autoload');
                        setTimeout(function(){
                            $('#first').click();
                        },1000);
                    } else {
                        connect.ladda('stop');
                        swal({
                            title: 'Database not found!',
                            type: "warning",
                            timer: 3000,
                            showConfirmButton: true
                        });
                    }
                });
            } else {
                //otherwise, stop all the requests.
                clearInterval(eventRateTimer);
                $('#connect').addClass('connect').addClass('btn-primary').removeClass('btn-warning');
                $('#connect').html('Connect');
                $('.chosen-select').attr("disabled", false).trigger("chosen:updated");
                connected = false;
            }

        });
        $('input').on('ifChecked', function(event) {
            if ($(this).attr('value') == 'mV' || $(this).attr('value') == 'FFT' || $(this).attr('value') == 'Power') {
                datatype = $(this).attr('value');
            } else if ($(this).attr('value') == 'Surf' || $(this).attr('value') == 'Phi') {
                dataview = $(this).attr('value');
                if (dataview == 'Surf') {
                    document.getElementById("surfview").style.display = "table";
                    document.getElementById("phiview").style.display = "none";
                } else if (dataview == 'Phi') {
                    document.getElementById("surfview").style.display = "none";
                    document.getElementById("phiview").style.display = "table";
                }
            }
            updatehtml_hd(hd_nbufs[i]);
        });

        $('#average_events').click(function() {
            updatehtml_hd(hd_nbufs[i], true)
        });

        $('#next').click(function() {
            if (i < hd_nbufs.length - 1) {
                i = i + 1;
                updatehtml_hd(hd_nbufs[i]);
            }; 
            sleep_interval = 100;
        });
        $('#prev').click(function() {
            if (i > 0) {
                i = i - 1;
                updatehtml_hd(hd_nbufs[i]);
            };
            sleep_interval = 100;
        });
        $('#first').click(function() {
            i = 0;
            updatehtml_hd(hd_nbufs[i]);
            sleep_interval = 100;
        });
        $('#last').click(function() {
            i = hd_nbufs.length - 1;
            updatehtml_hd(hd_nbufs[i]);
            sleep_interval = 100;
        });
        var auto_checkbox = $('#auto_checkbox')[0];
        var switchery = new Switchery(auto_checkbox, {
            color: '#1AB394'
        });
        var autoNext;
        auto_checkbox.onchange = function() {
            if (auto_checkbox.checked) {
                autoNext = setInterval(function() {
                    if (i < hd_nbufs.length - 1) {
                        i = i + 1;
                        updatehtml_hd(hd_nbufs[i]);
                    };
                }, 2000);
            } else {
                clearInterval(autoNext);
            };
        };


        $('#goto').click(function() {
            var keywords = parseInt($('#keywords').val());
            console.log(keywords);
            var index = hd_evnums.indexOf(keywords);
            if (index != -1 && keywords) {
                i = index;
                console.log(i);
                updatehtml_hd(hd_nbufs[i]);
                swal({  title: 'Matched wv and hd are found!', type: "success", timer: 3000, showConfirmButton: true});
            } else {
                swal({
                    title: 'Data not found!',
                    type: "warning",
                    timer: 3000,
                    showConfirmButton: true
                });
            }
        });
    });
    </script>
    {% endblock %}