 {% extends "base.html" %} {% block head %} {{ super() }}
 <link href="{{ url_for('static', filename='inspinia/css/plugins/footable/footable.core.css') }}" rel="stylesheet"> {% endblock %} {% block page_content %}
 <div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-lg-6">
            <div class="ibox float-e-margins" id="hk">
                <div class="ibox-title">
                    <h5>House Keeping</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <table data-sort="false" class="footable" data-page-size="20" id = 'hk_time' style="width:100%">
                        <tbody>
                            <tr>
                                <td>Index</td>
                                <td id = 'index'></td>
                                <td>Crc</td>
                                <td id = 'crc'></td>
                            </tr>
                            <tr>
                                <td>Time</td>
                                <td id='time'></td>
                                <td>Now</td>
                                <td id='now'></td>

                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="ibox float-e-margins" id="G_tools">
                <div class="ibox-title">
                    <h5>Graphing Tools</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <button class="btn btn-primary" id = 'table_button' type="button">Load Table Information</button>
                    <table>
                        <tbody>
                            <tr>
                                <td bgcolor="#FFFFFF" style="line-height:20px;" colspan=3>&nbsp;</td>
                            </tr>
                        </tbody>
                    </table>
                    <select id="table" class='chosen-select' style="width:160px" data-placeholder="Choose a table..">
                    </select>
                    <select id="table_data" class='chosen-select' style="width:160px" data-placeholder="Choose a table data.." >
                        <option selected> {{table_data_selected}} </option>
                    </select>
                    <select disabled id="table_num" class='chosen-select' style="width:160px" data-placeholder="Choose a number..">
                    </select>
                    <table>
                        <tbody>
                            <tr>
                                <td bgcolor="#FFFFFF" style="line-height:20px;" colspan=3>&nbsp;</td>
                            </tr>
                        </tbody>
                    </table>
                    <select id="table2" class='chosen-select' style="width:160px" data-placeholder="Choose a table..">
                    </select>
                    <select id="table_data2" class='chosen-select' style="width:160px" data-placeholder="Choose a table data.." >
                        <option selected> {{table_data_selected2}} </option>
                    </select>
                    <select disabled id="table_num2" class='chosen-select' style="width:160px" data-placeholder="Choose a number..">
                    </select>
                    <table>
                        <tbody>
                            <tr>
                                <td bgcolor="#FFFFFF" style="line-height:20px;" colspan=3>&nbsp;</td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn btn-primary" id = 'graph_button' type="button">Create Graph!</button>
                    <button class="btn btn-primary" id = 'scatter_button' type="button">Create Scatter Plot!</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dialog" class='hide'>
        <ul class="nav navbar-top-links">
            <span>Zoom Depth:</span>  <span id = 'zoomIndex'>1/1</span>
            <li><button type="button" id='reset' class="btn btn-success btn-xs">Reset</button> </li>
            <li><button type="button" id='undo' class="btn btn-success btn-xs">Undo</button> </li>
            <li><button type="button" id='redo' class="btn btn-success btn-xs">Redo</button> </li>
            <li><button type="button" id='1hour' class="btn btn-success btn-xs">1Hour</button> </li>
            <li><button type="button" id='6hours' class="btn btn-success btn-xs">6Hours</button> </li>
            <li><button type="button" id='24hours' class="btn btn-success btn-xs">24Hours</button> </li>
            <li><button type="button" id='1month' class="btn btn-success btn-xs">1Month</button> </li>
        </ul>
        <div id='chart1'></div>
        </br>
        <div class="col-sm-6">
            <div class="form-group">
                <label>Reference UTC</label>
                <input id="reference_time" value ="1483073293" placeholder="Enter your end time" class="form-control">
            </div>
        </div>
        <div class="col-sm-3">
            <div class="form-group">
                <label>Length(s)</label>
                <input id="length" value="21600" placeholder="Enter the number of seconds" class="form-control">
            </div>
        </div>
        <div class="col-sm-3">
            </br>
            <button id="request" type="button" class="btn btn-primary">Request</button>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script src="{{ url_for('static', filename='inspinia/js/plugins/footable/footable.all.min.js') }}"></script>
<script src="{{ url_for('static', filename='inspinia/js/plugins/sparkline/jquery.sparkline.min.js') }}"></script>
<script>
var hk_nbufs=[];
var hk_nows=[];
var hk_times=[];
var sshk_nbufs=[];
var sshk_nows=[];
var sshk_times=[];
var mon_nbufs=[];
var mon_nows=[];
var mon_times=[];
var cmd_nbufs=[];
var cmd_nows=[];
var cmd_times=[];
var adu5_pat_nbufs=[];
var adu5_pat_nows=[];
var adu5_pat_times=[];
var adu5_vtg_nbufs=[];
var adu5_vtg_nows=[];
var adu5_vtg_times=[];
var adu5_sat_nbufs=[];
var adu5_sat_nows=[];
var adu5_sat_times=[];
var g12_pos_nbufs=[];
var g12_pos_nows=[];
var g12_pos_times=[];
var g12_sat_nbufs=[];
var g12_sat_nows=[];
var g12_sat_times=[];
var i=0;
var j=0;
var k=0;
var l=0;
var m=0;
var n=0;
var o=0;
var p=0;
var q=0;
var offset_hk = 0;
var offset_sshk = 0;
var offset_mon = 0;
var offset_cmd = 0;
var offset_adu5_pat = 0;
var offset_adu5_vtg = 0;
var offset_adu5_sat = 0;
var offset_g12_pos = 0;
var offset_g12_sat = 0;

var connected = false;
var sleep_interval = 2000 //by default, re-access the database every 2seconds to see if there are any new data comes in.

var sync_on = false;

    function updatehtml_hk(hk) {
        if (!hk) return;
        $.getJSON('/api/' + ip_db + '/hk/' + hk, function(data) {
            $('#hk_time #index').html(i + 1 + "/" + hk_nbufs.length);
            $('#hk #crc').html(data.hk.crc);
            $('#hk_time #now').html(data.hk.now + " (" + timeConverter(data.hk.now) + ")");
            $('#hk_time #time').html(data.hk.time + " (" + timeConverter(data.hk.time) + ")");
        });

}


$(document).ready(function() {
    $('#navbar_vic').parent().addClass("active");

    /////// TABLES
    $('#table').empty();
    $('#table2').empty();
    table_list = ['']
    addmore = 1

    /////// TABLE_DATA
    $('#table').on("select2:closing", function(){
        table=$('#table option:selected').text();
        $.getJSON('/api/' + ip_db +  '/' + table + '/table_data/all', function(data) {
            table_data_names = data['table_data']
            $('#table_data').empty(); //remove all child nodes
            if (table != 'None'){
                for (var table_count = 0; table_count < table_data_names.length; table_count++){
                    if (table_count < table_data_names.length - 1){
                        newOption = $('<option>' + table_data_names[table_count] + '</option>');
                    }else{
                        newOption = $('<option>' + table_data_names[table_count] + '</option>');
                    }
                    
                    $('#table_data').append(newOption);
                }    
            }           
        });
    });

    $('#table2').on("select2:closing", function(){
        table=$('#table2 option:selected').text();
        $.getJSON('/api/' + ip_db +  '/' + table + '/table_data/all', function(data) {
            table_data_names = data['table_data']
            $('#table_data2').empty(); //remove all child nodes
            if (table != 'None'){
                for (var table_count = 0; table_count < table_data_names.length; table_count++){
                    if (table_count < table_data_names.length - 1){
                        newOption = $('<option>' + table_data_names[table_count] + '</option>');
                    }else{
                        newOption = $('<option>' + table_data_names[table_count] + '</option>');
                    }
                    
                    $('#table_data2').append(newOption);
                }    
            }           
        });
    });

    $.jqplot.config.enablePlugins = true;

    $('.footable').footable();
    function autoload() {
        $.getJSON('/api/' + ip_db + '/hk/nbufs/' + offset_hk, function(data) {
            new_length = data.hk_nbufs.length
            offset_hk += new_length
            hk_nbufs = hk_nbufs.concat(data.hk_nbufs);
            hk_nows = hk_nows.concat(data.hk_nows);
            hk_times = hk_times.concat(data.hk_times);
            
            $('#hk #index').html(i + 1 + "/" + hk_nbufs.length);
            $('#connect').removeClass('connect').removeClass('btn-primary').addClass('btn-warning');
            $('#connect').html('Disconnect');
            $('#ip').attr("disabled", true).trigger("chosen:updated");
            $('#db').attr("disabled", true).trigger("chosen:updated");
            // switchery.enable();
            connected = true;
            connect.ladda('stop');
        }).done(function() {
            setTimeout(function() {
                if (new_length) {
                    sleep_interval = 100;
                } else {
                    sleep_interval = Math.min(sleep_interval * 1.2, 60000);
                }
                if (connected == true) {
                    autoload();
                }
            }, sleep_interval);
        });
        $.getJSON('/api/' + ip_db + '/sshk/nbufs/' + offset_sshk, function(data) {
            offset_sshk += data.sshk_nbufs.length;
            sshk_nbufs = sshk_nbufs.concat(data.sshk_nbufs);
            sshk_nows = sshk_nows.concat(data.sshk_nows);
            sshk_times = sshk_times.concat(data.sshk_times);
            $('#sshk #index').html(n + 1 + "/" + sshk_nbufs.length);
            
            // console.log(sshk_nbufs);
            // console.log(sshk_nows);
            // console.log(sshk_times);
        });
        $.getJSON('/api/' + ip_db + '/adu5_pat/nbufs/' + offset_adu5_pat, function(data) {
            offset_adu5_pat += data.adu5_pat_nbufs.length;
            adu5_pat_nbufs = adu5_pat_nbufs.concat(data.adu5_pat_nbufs);
            adu5_pat_nows = adu5_pat_nows.concat(data.adu5_pat_nows);
            adu5_pat_times = adu5_pat_times.concat(data.adu5_pat_times);
            
            $('#gps #adu5_pat_index').html(k + 1 + "/" + adu5_pat_nbufs.length);
        });
        $.getJSON('/api/' + ip_db + '/adu5_vtg/nbufs/' + offset_adu5_vtg, function(data) {
            offset_adu5_vtg += data.adu5_vtg_nbufs.length;
            adu5_vtg_nbufs = adu5_vtg_nbufs.concat(data.adu5_vtg_nbufs);
            adu5_vtg_nows = adu5_vtg_nows.concat(data.adu5_vtg_nows);
            adu5_vtg_times = adu5_vtg_times.concat(data.adu5_vtg_times);
            $('#gps #adu5_vtg_index').html(l + 1 + "/" + adu5_vtg_times.length);
            
        });
        $.getJSON('/api/' + ip_db + '/adu5_sat/nbufs/' + offset_adu5_sat, function(data) {
            offset_adu5_sat += data.adu5_sat_nbufs.length;
            adu5_sat_nbufs = adu5_sat_nbufs.concat(data.adu5_sat_nbufs);
            adu5_sat_nows = adu5_sat_nows.concat(data.adu5_sat_nows);
            adu5_sat_times = adu5_sat_times.concat(data.adu5_sat_times);
            $('#gps #adu5_sat_index').html(p + 1 + "/" + adu5_sat_times.length);
            
        });
        $.getJSON('/api/' + ip_db + '/g12_pos/nbufs/' + offset_g12_pos, function(data){
           offset_g12_pos += data.g12_pos_nbufs.length;
           g12_pos_nbufs=g12_pos_nbufs.concat(data.g12_pos_nbufs);
           g12_pos_nows=g12_pos_nows.concat(data.g12_pos_nows);
           g12_pos_times=g12_pos_times.concat(data.g12_pos_times);
           $('#gps #g12_pos_index').html(o + 1 + "/" + g12_pos_nbufs.length);
           
       });
        $.getJSON('/api/' + ip_db + '/g12_sat/nbufs/' + offset_g12_sat, function(data){
            offset_g12_sat += data.g12_sat_nbufs.length;      
           g12_sat_nbufs=g12_sat_nbufs.concat(data.g12_sat_nbufs);
           g12_sat_nows=g12_sat_nows.concat(data.g12_sat_nows);
           g12_sat_times=g12_sat_times.concat(data.g12_sat_times);
           $('#gps #g12_sat_index').html(p + 1 + "/" + g12_sat_nbufs.length);
                  
       });
    }

    var connect = $('.ladda-button').ladda();
    $('#connect').click(function() {
        hk_nbufs = [];
        hk_nows = [];
        hk_times = [];
        sshk_nbufs = [];
        sshk_nows = [];
        sshk_times = [];
        mon_nbufs = [];
        mon_nows = [];
        mon_times = [];
        cmd_nbufs = [];
        cmd_nows = [];
        cmd_times = [];
        i = 0;
        j = 0;
        k = 0;
        l = 0;
        m = 0;
        n = 0;
        o=0;
        p=0;
        q=0;
        offset_hk = 0;
        offset_sshk = 0;
        offset_mon = 0;
        offset_cmd = 0;


        if ($(this).hasClass('connect')) {
            $.ajax({
                url: '/api/connect/' + ip + '/' + db
            }).done(function(response) {
                if (response == 'success') {
                    autoload();
                    setTimeout(function(){
                        $('#first').click();
                    },1000);
                } else {
                    connect.ladda('stop');
                    swal({
                        title: 'Database not found!',
                        type: "warning",
                        timer: 3000,
                        showConfirmButton: true
                    });
                }
            });
        } else {
            //otherwise, stop all the requests.
            $('#connect').addClass('connect').addClass('btn-primary').removeClass('btn-warning');
            $('#connect').html('Connect');
            //$('.chosen-select').attr("disabled", false).trigger("chosen:updated");
            $('#ip').attr("disabled", false);
            $('#db').attr("disabled", false);
            // if (switchery.isChecked()){
            //     $('.switchery').click();
            // };
            // switchery.disable();              
            connected = false;
        }
    });
    //update all html with hk index i;
    function updatehtml_all (i) {
        updatehtml_hk(hk_nbufs[i]);
   
}

    $('#next').click( function(){
        if (sync_on){
           if (i<hk_nbufs.length-1) {
               i=i+1;
               updatehtml_all(i);
           };
        }else{
            //console.log(hk_nbufs);
            //console.log(hk_nows);
            //console.log(hk_times);
            if (i<hk_nbufs.length-1)        {i=i+1; updatehtml_hk(hk_nbufs[i]);}
        }
    });
    $('#prev').click( function(){
        if (sync_on){
           if (i>0) {
               i=i-1;
               updatehtml_all(i);
           };
        }else{
            if (i>0)  {i=i-1; updatehtml_hk(hk_nbufs[i]);}
        }
    });
    $('#first').click( function(){
        if (sync_on){
            i=0;
            updatehtml_all(i);
        }else{
            {i=0; updatehtml_hk(hk_nbufs[i]);}
        }
    });
    $('#last').click( function(){
        if (sync_on){
            i=hk_nbufs.length-1;
            updatehtml_all(i);
        }else{
            {i=hk_nbufs.length-1; updatehtml_hk(hk_nbufs[i]);}
        }
    });
    $('#scatter_button').click(function(){
        console.log("INSIDE SCATTER");
        //test1 = eval_linear([2,0,8], [-2,0,6,8], [4,0,3,-3]);
        //console.log(test1);

        //console.log("printing time overlap");
        //test2 = find_time_overlap([1,2,15.3], [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,15.2,15.5,16,17,18,19]);
        //console.log(test2);




        var table_name = $('#table option:selected').text();
        var column_name = $('#table_data option:selected').text();
        var table_number = $('#table_num option:selected').text();
        var table_name2 = $('#table2 option:selected').text();
        var column_name2 = $('#table_data2 option:selected').text();
        var table_number2 = $('#table_num2 option:selected').text();
        var name = "Scatter_plot_" + table_name + '_' + column_name + table_number + "_and_" + table_name2 + '_' + column_name2 + table_number2;
        if (table_name2 == 'None' || column_name2 == 'None'){
            var name= table_name + '_' + column_name + table_number;
        }else{
            var name= table_name + '_' + column_name + table_number + ' and ' + table_name2 + '_' + column_name2 + table_number2;
        }
        


        if (table_name2 == 'None' || column_name2 == 'None'){
            console.log("there is nothing in dropdown 2");
            second_plot = false;
        }else{
            console.log("there is something in dropdown 2");
            second_plot = true;
        }

        table_name= table_name.split('_')[0];

        var multi_plot_1;
        var multi_plot_2;
        if (table_name== 'adu5' && (column_name!= 'numsats' || column_name!= 'd2mcm') ){
            multi_plot_1 = true;
        }else{
            multi_plot_1 = false;
        }

        table_name00 = table_name2.split('_')[0];

        if (table_name00 == 'adu5' && (column_name!= 'numsats' || column_name!= 'd2mcm') ){
            multi_plot_2 = true;
        }else{
            multi_plot_2 = false;
        }

        console.log("scatter_button pressed");
        var legend1 = true;
        var legend2 = false;
        var legend_list = [];
        if (table_name2 != 'None'){
            legend2 = true;
            legend1 = false;
            if (multi_plot_1 == true && multi_plot_2 == true){
                legend_list[0] = column_name + ' adu5A';
                legend_list[1] = column_name + ' adu5B';
                legend_list[2] = column_name2 + ' adu5A';
                legend_list[3] = column_name2 + ' adu5B';
                yaxis1 = "yaxis";
                yaxis2 = "yaxis";
                yaxis3 = "y2axis";
                yaxis4 = "y2axis";
            } else if (multi_plot_1 == true && multi_plot_2 == false){
                legend_list[0] = column_name + ' adu5A';
                legend_list[1] = column_name + ' adu5B';
                legend_list[2] = column_name2 + ' ' + table_number2;
                yaxis1 = "yaxis";
                yaxis2 = "yaxis";
                yaxis3 = "y2axis";
            } else if (multi_plot_1 == false && multi_plot_2 == true){
                legend_list[0] = column_name + ' ' + table_number;
                legend_list[1] = column_name2 + ' adu5A';
                legend_list[2] = column_name2 + ' adu5B';
                yaxis1 = "yaxis";
                yaxis2 = "y2axis";
                yaxis3 = "y2axis";
            } else {
                legend_list[0] = column_name + ' ' + table_number;
                legend_list[1] = column_name2 + ' ' + table_number2;
                yaxis1 = "yaxis";
                yaxis2 = "y2axis";
            } 
        } else {
            if (multi_plot_1 == true){
                legend_list[0] = column_name + ' adu5A';
                legend_list[1] = column_name + ' adu5B';
                yaxis1 = "yaxis";
                yaxis2 = "yaxis";
            }else{
                legend_list[0] = column_name + ' ' + table_number;
                yaxis1 = "yaxis";
            }
        }

        console.log(legend_list);
        console.log(name);

        // console.log($(this).closest('.ibox').attr('id'));
        if ($("#dialog_" + name).length) {
            console.log("load if");
            $("#dialog_" + name).dialog('open');
            $("#dialog_" + name).find('input[id="reference_time"]').val(hk_nows[i]);
        } else {
            console.log('load else');
            var $newDialog = $('#dialog').clone();
            $newDialog.attr('id', 'dialog_' + name);
            $newDialog.removeClass('hide');
            $newDialog.attr('title', name);
            $newDialog.prepend('<div id="' + "plot_" + name + '"  class="dialog_plot" ></div>');
            $newDialog.find('input[id="reference_time"]').val(hk_nows[i]);
            $newDialog.dialog({
                width: 700,
                height: 500,
            });
            $newDialog.data('zoomStack', [[hk_nows[i], 21600]]);
            $newDialog.data('zoomStackIndex', 0);
            var line1 = [
            ['2008-09-30', 14]
            ];
            var plot1 = $.jqplot('plot_' + name, [line1], {
                title: 'double click to reset the zoom',
                axes: {
                    xaxis: {
                        renderer: $.jqplot.DateAxisRenderer,
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            // formatString: '%M:%S%#N ',
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    },
                    x2axis: {
                        renderer: $.jqplot.CategoryAxisRenderer,
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            // formatString: '%M:%S%#N ',
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    },
                    yaxis: {
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    },
                    y2axis: {
                        renderer: $.jqplot.CategoryAxisRenderer,
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            // formatString: '%M:%S%#N ',
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    },
                    y3axis: {
                        renderer: $.jqplot.CategoryAxisRenderer,
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            // formatString: '%M:%S%#N ',
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    },
                    y4axis: {
                        renderer: $.jqplot.CategoryAxisRenderer,
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            // formatString: '%M:%S%#N ',
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    },
                },
                series: [
                    {
                        lineWidth: .5,
                        yaxis: yaxis1,
                        markerOptions: {
                            size: 2,
                            color: 'blue' 
                        }
                    },
                    {
                        lineWidth: .5,
                        yaxis: yaxis2,
                        markerOptions: {
                            size: 2,
                            color: 'orange' 
                        }
                    },
                    {
                        lineWidth: .5,
                        yaxis: yaxis3,
                        markerOptions: {
                            size: 2,
                            color: 'grey' 
                        }
                    },
                    {
                        lineWidth: .5,
                        yaxis: yaxis4,
                        markerOptions: {
                            size: 2,
                            color: 'green' 
                        }
                    }
                ],
                legend: {
                    show: true,
                    labels: legend_list,
                    location: 'ne',
                    rowSpacing: '0px'
                },
                axesDefaults:{
                    // color the axes baselines the same color as the series.
                    useSeriesColor: true,
                    rendererOptions: {
                        // align ticks for each axis across the grid
                        alignTicks: true
                    }
                }, 
                cursor: {
                    zoom: true,
                    looseZoom: true,
                    // showTooltip:true, 
                    followMouse: true,
                    showTooltipOutsideZoom: true,
                    constrainOutsideZoom: false
                }
            });

            $newDialog.dialog({
                resize: function(event, ui) {
                    $("#plot_" + name).height(Math.max(100, $newDialog.height() - 120));
                    plot1.replot({
                        resetAxes: true,
                    });
                }
            });
        }

        //function eval_linear (array_times, array_x1, array_y1, array_x2, array_y2) {
        function eval_linear (pointsToEvaluate, functionValuesX, functionValuesY) {
            var results = [];
            pointsToEvaluate.forEach(function (point) {
                //console.log("Printing point");
                //console.log(point);
                var index = findIntervalLeftBorderIndex(point, functionValuesX);
                //console.log("Printing index");
                //console.log(index);
                if (index == functionValuesX.length -1){
                    index --;
                }
                results.push(linear_interp(point, functionValuesX[index], functionValuesY[index]
      , functionValuesX[index + 1], functionValuesY[index + 1]));
            });
            return results
        }

        function findIntervalLeftBorderIndex (point, intervals) {
            //If point is beyond given intervals
            if (point < intervals[0]){
              return 0;
            }
            if (point > intervals[intervals.length - 1]){
              return intervals.length - 1;
            }
            //If point is inside interval
            //Start searching on a full range of intervals
            var indexOfNumberToCompare; 
            var leftBorderIndex = 0;
            var rightBorderIndex = intervals.length - 1;
            //Reduce searching range till it find an interval point belongs to using binary search
            while (rightBorderIndex - leftBorderIndex !== 1) {
              indexOfNumberToCompare = leftBorderIndex + Math.floor((rightBorderIndex - leftBorderIndex)/2);
              (point >= intervals[indexOfNumberToCompare]) ? leftBorderIndex=indexOfNumberToCompare:rightBorderIndex=indexOfNumberToCompare;
            }
            //console.log("printing leftBorderIndex");
            //console.log(leftBorderIndex);
            return leftBorderIndex
        }

        function linear_interp (x,x1,y1,x2,y2) {
            var a = (y2 - y1) / (x2 - x1);
            var b = -a * x1 + y1;
            var c = a * x + b;
            //console.log("printing c");
            //console.log(c);
            return c;
        }

        function find_time_overlap (time_array1, time_array2) {
            // looks for a section of overlap of two time arrays and returns that overlap
            //used for linear interpolation
            var array_section = [];
            // starting array is where we want to start
            var starting_array = [];
            // first array is the array that starts at the ealiest time
            var first_array = [];
            // ending array is the array that has the smallest ending time, thus where to stop at
            var ending_array = [];

            // Find array that begins second
            if (time_array1[0] > time_array2[0]){
                // array 1 starts later
                starting_array = time_array1;
                first_array = time_array2;
            }
            else if (time_array1[0] < time_array2[0]){
                // array 1 starts first
                starting_array = time_array2;
                first_array = time_array1;
            }
            else{
                //just start with array 1
                starting_array = time_array1;
                first_array = time_array2;
            }

            //find array that ends first
            if (time_array1[time_array1.length-1] > time_array2[time_array2.length-1]){
                // array 1 ends later
                ending_array = time_array2;
            }
            else if (time_array1[time_array1.length-1] < time_array2[time_array2.length-1]){
                // array 1 ends first
                ending_array = time_array1;
            }
            else{
                //just start with array 1
                ending_array = time_array1;
            }

            // get the first array to be at the correct index
            var get_synced = 0;
            while (first_array[get_synced] < starting_array[0]){
                get_synced++
            }

            //console.log("get_synced is: " + get_synced);
            //console.log("getting first array synced: " + first_array[get_synced]);
            //console.log(first_array);
            //console.log(starting_array);
            //console.log(ending_array);
            //console.log("ending array length: "+(ending_array.length+get_synced));

            step1 = 0;
            step2 = get_synced;
            var exit = false;
            while (exit != true){

                //get out of loop
                if (first_array[step2] >= ending_array[ending_array.length-1] && starting_array[step1] >= ending_array[ending_array.length-1]){
                    exit = true;
                }
                //(var step1 = 0; step1 < ending_array.length; step1++){
                //console.log("array 1: " + starting_array[step1]+ " and step 1 is: "+step1);
                //console.log("array 2: " + first_array[step2]+ " and step 2 is: "+step2);
                if (starting_array[step1] < first_array[step2]){
                    if (starting_array[step1] != array_section[array_section.length-1]){
                        //console.log("array 1: " + starting_array[step1]);
                        //console.log("array 2: " + first_array[step2]);
                        array_section.push(starting_array[step1]);
                    }
                    //make sure not to go past the end!
                    if (starting_array[step1] < ending_array[ending_array.length-1]){
                        step1++;
                    }
                }
                else if (starting_array[step1] > first_array[step2]){
                    if (first_array[step2] != array_section[array_section.length-1]){
                        //console.log("array 1: " + starting_array[step1]);
                        //console.log("array 2: " + first_array[step2]);
                        array_section.push(first_array[step2]);
                    }
                    if (first_array[step2] < ending_array[ending_array.length-1]){
                        step2++;
                    }
                }
                else{
                    if (first_array[step2] != array_section[array_section.length-1]){
                        //console.log("array 1: " + starting_array[step1]);
                        //console.log("array 2: " + first_array[step2]);
                        array_section.push(first_array[step2]);
                    }
                    if (first_array[step2] < ending_array[ending_array.length-1]){
                        step2++;
                    }
                }
            }
            return array_section
        }

        function replotTimeline (table_name, column_name, table_name2, column_name2, end_time, length) {
            console.log("replot scatter");
            //console.log("table_name2 :" + table_name2);
            //console.log("column_name2 :" + column_name2);
            var table_number = $('#table_num option:selected').text();
            var table_number2 = $('#table_num2 option:selected').text();
            var addition = "";
            var addition2 = "";
            if (table_number != ''){
                column_name = column_name + "-" + table_number;
            }
            if (table_number2 != ''){
                column_name2 = column_name2 + "-" + table_number2;
            }

            $.getJSON('/api/' + ip_db + '/history/' + table_name + '/' + column_name + '/' + (end_time - length) + '/' + end_time, function(data) {
                datalist = [];
                console.log(data);
                var step = 1;
                if (data.data && data.data.length > 50000){
                    // step = data.data.length/5000;
                    step = Math.floor(data.data.length/5000);
                }
                if (data.data_a && data.data_a.length > 50000){
                    // step = data.data.length/5000;
                    step = Math.floor(data.data_a.length/5000);
                }
                if (Object.keys(data).length == 2){
                    // datalist = [data.data_a, data.data_b];
                    new_data_a = [];
                    for (var i =0; i< data.data_a.length; i += step){
                        element = data.data_a[i];
                        new_data_a.push([element[0] + timeZoneShift, element[1]]);
                    }
                    new_data_b = [];
                    for (var i =0; i< data.data_b.length; i += step){
                        element = data.data_b[i];
                        new_data_b.push([element[0] + timeZoneShift, element[1]]);
                    }
                    console.log("before if statement");
                    console.log(second_plot);
                    if(second_plot){
                        console.log("inside second_plot if");
                        new_data_c=[];
                        $.getJSON('/api/' + ip_db + '/history/' + table_name2 + '/' + column_name2 + addition2 + '/' + (end_time - length) + '/' + end_time, function(data) {
                            console.log(data);
                            var step2 = 1;
                            if (data.data && data.data.length > 50000){
                                // step = data.data.length/5000;
                                step2 = Math.floor(data.data.length/5000);
                            }
                            if (data.data_a && data.data_a.length > 50000){
                                // step = data.data.length/5000;
                                step2 = Math.floor(data.data_a.length/5000);
                            }
                            if (Object.keys(data).length == 2){
                                // datalist = [data.data_a, data.data_b];
                                new_data_c = [];
                                for (var i =0; i< data.data_a.length; i += step){
                                    element = data.data_a[i];
                                    new_data_c.push([element[0] + timeZoneShift, element[1]]);
                                }
                                new_data_d = [];
                                for (var i =0; i< data.data_b.length; i += step2){
                                    element = data.data_b[i];
                                    new_data_d.push([element[0] + timeZoneShift, element[1]]);
                                }
                                datalist = [new_data_a, new_data_b, new_data_c, new_data_d];
                                console.log(datalist);
                                console.log("All four new_data")
                                plot1.replot({
                                    data: datalist
                                });
                            }else{
                                for (var i =0; i< data.data.length; i += step2){
                                    element = data.data[i];
                                    new_data_c.push([element[0] + timeZoneShift, element[1]]);
                                }
                                datalist = [new_data_a, new_data_b, new_data_c];
                                console.log(datalist);
                                console.log("First two new_data are a&b, second is c")
                                plot1.replot({
                                    data: datalist
                                });
                            }
                        });
                    }
                    else{
                        datalist = [new_data_a, new_data_b];
                        console.log(datalist);
                        plot1.replot({
                            data: datalist
                        });
                    }
                }else{
                    new_data_a = [];
                    for (var i =0; i< data.data.length; i += step){
                        element = data.data[i];
                        new_data_a.push([element[0] + timeZoneShift, element[1]]);
                    }
                    if(second_plot){
                        $.getJSON('/api/' + ip_db + '/history/' + table_name2 + '/' + column_name2 + addition2 + '/' + (end_time - length) + '/' + end_time, function(data) {
                            var step2 = 1;
                            if (data.data && data.data.length > 50000){
                                // step = data.data.length/5000;
                                step2 = Math.floor(data.data.length/5000);
                            }
                            if (data.data_a && data.data_a.length > 50000){
                                // step = data.data.length/5000;
                                step2 = Math.floor(data.data_a.length/5000);
                            }
                            if (Object.keys(data).length == 2){
                                // datalist = [data.data_a, data.data_b];
                                new_data_b = [];
                                for (var i =0; i< data.data_a.length; i += step){
                                    element = data.data_a[i];
                                    new_data_b.push([element[0] + timeZoneShift, element[1]]);
                                }
                                new_data_c = [];
                                for (var i =0; i< data.data_b.length; i += step){
                                    element = data.data_b[i];
                                    new_data_c.push([element[0] + timeZoneShift, element[1]]);
                                }
                                datalist = [new_data_a, new_data_b, new_data_c];
                                console.log(datalist);
                                console.log("First new_data is a while second is b&c")
                                plot1.replot({
                                    data: datalist
                                });
                            }else{
                                new_data_b = [];
                                for (var i =0; i< data.data.length; i += step2){
                                    element = data.data[i];
                                    new_data_b.push([element[0] + timeZoneShift, element[1]]);
                                }
                                datalist = [new_data_a, new_data_b];
                                console.log(datalist);
                                console.log("new_data a and b")

                                plot1.replot({
                                    data: datalist
                                });
                            }
                        });
                    }else{
                        console.log(data.data.length);
                        console.log("only new_data_a");
                        datalist = [new_data_a];
                        console.log(datalist);
                        plot1.replot({
                            data: datalist
                        });
                    }
                }

            });

        }

        $("#dialog_" + name).on('jqplotZoom', function(ev, gridpos, datapos, plot, cursor){
            end_time = parseInt((plot.axes.xaxis.max - timeZoneShift)/1000);
            length = end_time - parseInt((plot.axes.xaxis.min - timeZoneShift)/1000);
            $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
            $("#dialog_" + name).find('input[id="length"]').val(length);
            var new_index = $(this).data('zoomStackIndex') + 1;
            $(this).data('zoomStackIndex', new_index);
            var new_zoomStack = $(this).data('zoomStack').slice(0, new_index);
            new_zoomStack.push([end_time, length]);
            $(this).data('zoomStack', new_zoomStack);
            console.log(new_index + 1 + '/' + new_zoomStack.length);
            $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
        });

        $("#dialog_" + name + " #reset").click(function() {
            $("#dialog_" + name).data('zoomStackIndex', 0);
            $("#dialog_" + name).data('zoomStack', [[hk_nows[i], 21600]]);
            $("#dialog_" + name).find('input[id="reference_time"]').val(hk_nows[i]);
            $("#dialog_" + name).find('input[id="length"]').val(21600);
            $("#dialog_" + name).find('button[id="request"]').trigger("click");
            $("#dialog_" + name + " #zoomIndex").text('1/1');
        });

        $("#dialog_" + name + " #undo").click(function() {
            if ($("#dialog_" + name).data('zoomStack').length > 1){
                var index = $("#dialog_" + name).data('zoomStackIndex') - 1;
                if (index >= 0){
                    $("#dialog_" + name).data('zoomStackIndex', index);
                    var zoomStack = $("#dialog_" + name).data('zoomStack');
                    var zoom = zoomStack[index];
                    var end_time = zoom[0];
                    var length = zoom[1]
                    $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                    $("#dialog_" + name).find('input[id="length"]').val(length);
                    $("#dialog_" + name).find('button[id="request"]').trigger("click");
                    $("#dialog_" + name + " #zoomIndex").text(index + 1 + '/' + zoomStack.length);
                }
            }
        });

        $("#dialog_" + name + " #redo").click(function() {
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex') + 1;
                if (index < stack_length){
                    $("#dialog_" + name).data('zoomStackIndex', index);
                    var zoomStack = $("#dialog_" + name).data('zoomStack');
                    var zoom = zoomStack[index];
                    var end_time = zoom[0];
                    var length = zoom[1]
                    $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                    $("#dialog_" + name).find('input[id="length"]').val(length);
                    $("#dialog_" + name).find('button[id="request"]').trigger("click");
                    $("#dialog_" + name + " #zoomIndex").text(index + 1 + '/' + zoomStack.length);
                }
            }
        });

        $("#dialog_" + name + " #1hour").click(function() {
            console.log('1hour');
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 3600;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name + " #6hours").click(function() {
            console.log('6hour');
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 21600;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name + " #24hours").click(function() {
            console.log('24hour');
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 86400;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name + " #1month").click(function() {
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 2592000;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name).find('button[id="request"]').click(function() {
            console.log("REPLOT_dialog victor's");
            var end_time = $newDialog.find('input[id="reference_time"]').val();
            var length = $newDialog.find('input[id="length"]').val();
            console.log("**** table 2:" + table_name2);
            console.log("**** column 2:" + column_name2);
            replotTimeline(table_name, column_name, table_name2, column_name2, end_time, length);
        });

        $("#dialog_" + name).find('button[id="request"]').trigger("click");
    });

    $('#graph_button').click( function(){
        // console.log($('#table option:selected').text())
        // console.log($('#table_data option:selected').text())
        //console.log($('#table2 option:selected').text())
        //console.log($('#table_data2 option:selected').text())

        var table_name = $('#table option:selected').text();
        var column_name = $('#table_data option:selected').text();
        var table_number = $('#table_num option:selected').text();
        var table_name2 = $('#table2 option:selected').text();
        var column_name2 = $('#table_data2 option:selected').text();
        var table_number2 = $('#table_num2 option:selected').text();
        //var name = table_name + '_' + column_name + table_number + "_and_" + table_name2 + '_' + column_name2 + table_number2;
        console.log('-'+table_number+'-');
        if (table_name2 == 'None' || column_name2 == 'None'){
            var name= table_name + '_' + column_name + table_number;
        }else{
            var name= table_name + '_' + column_name + table_number + '_and_' + table_name2 + '_' + column_name2 + table_number2;
        }
        


        if (table_name2 == 'None' || column_name2 == 'None'){
            console.log("there is nothing in dropdown 2");
            second_plot = false;
        }else{
            console.log("there is something in dropdown 2");
            second_plot = true;
        }

        table_name0= table_name.split('_')[0];

        var multi_plot_1;
        var multi_plot_2;
        if (table_name0== 'adu5' && (column_name!= 'numsats' || column_name!= 'd2mcm') ){
            multi_plot_1 = true;
        }else{
            multi_plot_1 = false;
        }

        table_name00 = table_name2.split('_')[0];

        if (table_name00 == 'adu5' && (column_name!= 'numsats' || column_name!= 'd2mcm') ){
            multi_plot_2 = true;
        }else{
            multi_plot_2 = false;
        }

        var legend1 = true;
        var legend2 = false;
        var legend_list = [];
        if (table_name2 != 'None'){
            legend2 = true;
            legend1 = false;
            if (multi_plot_1 == true && multi_plot_2 == true){
                legend_list[0] = column_name + ' adu5A';
                legend_list[1] = column_name + ' adu5B';
                legend_list[2] = column_name2 + ' adu5A';
                legend_list[3] = column_name2 + ' adu5B';
                yaxis1 = "yaxis";
                yaxis2 = "yaxis";
                yaxis3 = "y2axis";
                yaxis4 = "y2axis";
            } else if (multi_plot_1 == true && multi_plot_2 == false){
                legend_list[0] = column_name + ' adu5A';
                legend_list[1] = column_name + ' adu5B';
                legend_list[2] = column_name2 + ' ' + table_number2;
                yaxis1 = "yaxis";
                yaxis2 = "yaxis";
                yaxis3 = "y2axis";
            } else if (multi_plot_1 == false && multi_plot_2 == true){
                legend_list[0] = column_name + ' ' + table_number;
                legend_list[1] = column_name2 + ' adu5A';
                legend_list[2] = column_name2 + ' adu5B';
                yaxis1 = "yaxis";
                yaxis2 = "y2axis";
                yaxis3 = "y2axis";
            } else {
                legend_list[0] = column_name + ' ' + table_number;
                legend_list[1] = column_name2 + ' ' + table_number2;
                yaxis1 = "yaxis";
                yaxis2 = "y2axis";
            } 
        } else {
            if (multi_plot_1 == true){
                legend_list[0] = column_name + ' adu5A';
                legend_list[1] = column_name + ' adu5B';
                yaxis1 = "yaxis";
                yaxis2 = "yaxis";
            }else{
                legend_list[0] = column_name + ' ' + table_number;
                yaxis1 = "yaxis";
            }
        }

        console.log(legend_list);
        console.log(name);

        // console.log($(this).closest('.ibox').attr('id'));
        if ($("#dialog_" + name).length) {
            console.log("load if");
            $("#dialog_" + name).dialog('open');
            $("#dialog_" + name).find('input[id="reference_time"]').val(hk_nows[i]);
        } else {
            console.log('load else');
            var $newDialog = $('#dialog').clone();
            $newDialog.attr('id', 'dialog_' + name);
            $newDialog.removeClass('hide');
            $newDialog.attr('title', name);
            $newDialog.prepend('<div id="' + "plot_" + name + '"  class="dialog_plot" ></div>');
            $newDialog.find('input[id="reference_time"]').val(hk_nows[i]);
            $newDialog.dialog({
                width: 700,
                height: 500,
            });
            $newDialog.data('zoomStack', [[hk_nows[i], 21600]]);
            $newDialog.data('zoomStackIndex', 0);
            var line1 = [
            ['2008-09-30', 14]
            ];
            var plot1 = $.jqplot('plot_' + name, [line1], {
                title: 'double click to reset the zoom',
                axes: {
                    xaxis: {
                        renderer: $.jqplot.DateAxisRenderer,
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            // formatString: '%M:%S%#N ',
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    },
                    yaxis: {
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    },
                    y2axis: {
                        renderer: $.jqplot.CategoryAxisRenderer,
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            // formatString: '%M:%S%#N ',
                            fontSize: '10pt',
                            fontFamily: 'Tahoma',
                        }
                    },
                },
                series: [
                    {
                        lineWidth: .5,
                        yaxis: yaxis1,
                        markerOptions: {
                            size: 2,
                            color: 'blue' 
                        }
                    },
                    {
                        lineWidth: .5,
                        yaxis: yaxis2,
                        markerOptions: {
                            size: 2,
                            color: 'orange' 
                        }
                    },
                    {
                        lineWidth: .5,
                        yaxis: yaxis3,
                        markerOptions: {
                            size: 2,
                            color: 'grey' 
                        }
                    },
                    {
                        lineWidth: .5,
                        yaxis: yaxis4,
                        markerOptions: {
                            size: 2,
                            color: 'green' 
                        }
                    }
                ],
                legend: {
                    show: true,
                    labels: legend_list,
                    location: 'ne',
                    rowSpacing: '0px'
                },
                axesDefaults:{
                    // color the axes baselines the same color as the series.
                    useSeriesColor: true,
                    rendererOptions: {
                        // align ticks for each axis across the grid
                        alignTicks: true
                    }
                }, 
                cursor: {
                    zoom: true,
                    looseZoom: true,
                    // showTooltip:true, 
                    followMouse: true,
                    showTooltipOutsideZoom: true,
                    constrainOutsideZoom: false
                }
            });

            $newDialog.dialog({
                resize: function(event, ui) {
                    $("#plot_" + name).height(Math.max(100, $newDialog.height() - 120));
                    plot1.replot({
                        resetAxes: true,
                    });
                }
            });
        }

        function replotTimeline (table_name, column_name, table_name2, column_name2, end_time, length) {
            console.log("replot victor's");
            //console.log("table_name2 :" + table_name2);
            //console.log("column_name2 :" + column_name2);
            var table_number = $('#table_num option:selected').text();
            var table_number2 = $('#table_num2 option:selected').text();
            var addition = "";
            var addition2 = "";
            if (table_number != ''){
                column_name = column_name + "-" + table_number;
            }
            if (table_number2 != ''){
                column_name2 = column_name2 + "-" + table_number2;
            }

            $.getJSON('/api/' + ip_db + '/history/' + table_name + '/' + column_name + '/' + (end_time - length) + '/' + end_time, function(data) {
                datalist = [];
                console.log(data);
                var step = 1;
                if (data.data && data.data.length > 50000){
                    // step = data.data.length/5000;
                    step = Math.floor(data.data.length/5000);
                }
                if (data.data_a && data.data_a.length > 50000){
                    // step = data.data.length/5000;
                    step = Math.floor(data.data_a.length/5000);
                }
                if (Object.keys(data).length == 2){
                    // datalist = [data.data_a, data.data_b];
                    new_data_a = [];
                    for (var i =0; i< data.data_a.length; i += step){
                        element = data.data_a[i];
                        new_data_a.push([element[0] + timeZoneShift, element[1]]);
                    }
                    new_data_b = [];
                    for (var i =0; i< data.data_b.length; i += step){
                        element = data.data_b[i];
                        new_data_b.push([element[0] + timeZoneShift, element[1]]);
                    }
                    console.log("before if statement");
                    console.log(second_plot);
                    if(second_plot){
                        console.log("inside second_plot if");
                        new_data_c=[];
                        $.getJSON('/api/' + ip_db + '/history/' + table_name2 + '/' + column_name2 + addition2 + '/' + (end_time - length) + '/' + end_time, function(data) {
                            console.log(data);
                            var step2 = 1;
                            if (data.data && data.data.length > 50000){
                                // step = data.data.length/5000;
                                step2 = Math.floor(data.data.length/5000);
                            }
                            if (data.data_a && data.data_a.length > 50000){
                                // step = data.data.length/5000;
                                step2 = Math.floor(data.data_a.length/5000);
                            }
                            if (Object.keys(data).length == 2){
                                // datalist = [data.data_a, data.data_b];
                                new_data_c = [];
                                for (var i =0; i< data.data_a.length; i += step){
                                    element = data.data_a[i];
                                    new_data_c.push([element[0] + timeZoneShift, element[1]]);
                                }
                                new_data_d = [];
                                for (var i =0; i< data.data_b.length; i += step2){
                                    element = data.data_b[i];
                                    new_data_d.push([element[0] + timeZoneShift, element[1]]);
                                }
                                datalist = [new_data_a, new_data_b, new_data_c, new_data_d];
                                console.log(datalist);
                                console.log("All four new_data")
                                plot1.replot({
                                    data: datalist
                                });
                            }else{
                                for (var i =0; i< data.data.length; i += step2){
                                    element = data.data[i];
                                    new_data_c.push([element[0] + timeZoneShift, element[1]]);
                                }
                                datalist = [new_data_a, new_data_b, new_data_c];
                                console.log(datalist);
                                console.log("First two new_data are a&b, second is c")
                                plot1.replot({
                                    data: datalist
                                });
                            }
                        });
                    }
                    else{
                        datalist = [new_data_a, new_data_b];
                        console.log(datalist);
                        plot1.replot({
                            data: datalist
                        });
                    }
                }else{
                    new_data_a = [];
                    for (var i =0; i< data.data.length; i += step){
                        element = data.data[i];
                        new_data_a.push([element[0] + timeZoneShift, element[1]]);
                    }
                    if(second_plot){
                        $.getJSON('/api/' + ip_db + '/history/' + table_name2 + '/' + column_name2 + addition2 + '/' + (end_time - length) + '/' + end_time, function(data) {
                            var step2 = 1;
                            if (data.data && data.data.length > 50000){
                                // step = data.data.length/5000;
                                step2 = Math.floor(data.data.length/5000);
                            }
                            if (data.data_a && data.data_a.length > 50000){
                                // step = data.data.length/5000;
                                step2 = Math.floor(data.data_a.length/5000);
                            }
                            if (Object.keys(data).length == 2){
                                // datalist = [data.data_a, data.data_b];
                                new_data_b = [];
                                for (var i =0; i< data.data_a.length; i += step){
                                    element = data.data_a[i];
                                    new_data_b.push([element[0] + timeZoneShift, element[1]]);
                                }
                                new_data_c = [];
                                for (var i =0; i< data.data_b.length; i += step){
                                    element = data.data_b[i];
                                    new_data_c.push([element[0] + timeZoneShift, element[1]]);
                                }
                                datalist = [new_data_a, new_data_b, new_data_c];
                                console.log(datalist);
                                console.log("First new_data is a while second is b&c")
                                plot1.replot({
                                    data: datalist
                                });
                            }else{
                                new_data_b = [];
                                for (var i =0; i< data.data.length; i += step2){
                                    element = data.data[i];
                                    new_data_b.push([element[0] + timeZoneShift, element[1]]);
                                }
                                datalist = [new_data_a, new_data_b];
                                console.log(datalist);
                                console.log("new_data a and b")

                                plot1.replot({
                                    data: datalist
                                });
                            }
                        });
                    }else{
                        console.log(data.data.length);
                        console.log("only new_data_a");
                        datalist = [new_data_a];
                        console.log(datalist);
                        plot1.replot({
                            data: datalist
                        });
                    }
                }

            });

        }

        $("#dialog_" + name).on('jqplotZoom', function(ev, gridpos, datapos, plot, cursor){
            end_time = parseInt((plot.axes.xaxis.max - timeZoneShift)/1000);
            length = end_time - parseInt((plot.axes.xaxis.min - timeZoneShift)/1000);
            $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
            $("#dialog_" + name).find('input[id="length"]').val(length);
            var new_index = $(this).data('zoomStackIndex') + 1;
            $(this).data('zoomStackIndex', new_index);
            var new_zoomStack = $(this).data('zoomStack').slice(0, new_index);
            new_zoomStack.push([end_time, length]);
            $(this).data('zoomStack', new_zoomStack);
            console.log(new_index + 1 + '/' + new_zoomStack.length);
            $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
        });

        $("#dialog_" + name + " #reset").click(function() {
            $("#dialog_" + name).data('zoomStackIndex', 0);
            $("#dialog_" + name).data('zoomStack', [[hk_nows[i], 21600]]);
            $("#dialog_" + name).find('input[id="reference_time"]').val(hk_nows[i]);
            $("#dialog_" + name).find('input[id="length"]').val(21600);
            $("#dialog_" + name).find('button[id="request"]').trigger("click");
            $("#dialog_" + name + " #zoomIndex").text('1/1');
        });

        $("#dialog_" + name + " #undo").click(function() {
            if ($("#dialog_" + name).data('zoomStack').length > 1){
                var index = $("#dialog_" + name).data('zoomStackIndex') - 1;
                if (index >= 0){
                    $("#dialog_" + name).data('zoomStackIndex', index);
                    var zoomStack = $("#dialog_" + name).data('zoomStack');
                    var zoom = zoomStack[index];
                    var end_time = zoom[0];
                    var length = zoom[1]
                    $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                    $("#dialog_" + name).find('input[id="length"]').val(length);
                    $("#dialog_" + name).find('button[id="request"]').trigger("click");
                    $("#dialog_" + name + " #zoomIndex").text(index + 1 + '/' + zoomStack.length);
                }
            }
        });

        $("#dialog_" + name + " #redo").click(function() {
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex') + 1;
                if (index < stack_length){
                    $("#dialog_" + name).data('zoomStackIndex', index);
                    var zoomStack = $("#dialog_" + name).data('zoomStack');
                    var zoom = zoomStack[index];
                    var end_time = zoom[0];
                    var length = zoom[1]
                    $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                    $("#dialog_" + name).find('input[id="length"]').val(length);
                    $("#dialog_" + name).find('button[id="request"]').trigger("click");
                    $("#dialog_" + name + " #zoomIndex").text(index + 1 + '/' + zoomStack.length);
                }
            }
        });

        $("#dialog_" + name + " #1hour").click(function() {
            console.log('1hour');
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 3600;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name + " #6hours").click(function() {
            console.log('6hour');
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 21600;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name + " #24hours").click(function() {
            console.log('24hour');
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 86400;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name + " #1month").click(function() {
            var stack_length = $("#dialog_" + name).data('zoomStack').length;
            if ( stack_length > 0){
                var index = $("#dialog_" + name).data('zoomStackIndex');

                var new_index = index + 1;
                $("#dialog_" + name).data('zoomStackIndex', new_index);
                var new_zoomStack = $("#dialog_" + name).data('zoomStack').slice(0, new_index);
                var end_time = new_zoomStack[index][0];
                var length = 2592000;
                new_zoomStack.push([end_time, length])
                $("#dialog_" + name).data('zoomStack', new_zoomStack);
                $("#dialog_" + name).find('input[id="reference_time"]').val(end_time);
                $("#dialog_" + name).find('input[id="length"]').val(length);
                $("#dialog_" + name).find('button[id="request"]').trigger("click");
                $("#dialog_" + name + " #zoomIndex").text(new_index + 1 + '/' + new_zoomStack.length);
            }
        });

        $("#dialog_" + name).find('button[id="request"]').click(function() {
            console.log("REPLOT_dialog victor's");
            var end_time = $newDialog.find('input[id="reference_time"]').val();
            var length = $newDialog.find('input[id="length"]').val();
            console.log("**** table 2:" + table_name2);
            console.log("**** column 2:" + column_name2);
            replotTimeline(table_name, column_name, table_name2, column_name2, end_time, length);
        });

        $("#dialog_" + name).find('button[id="request"]').trigger("click");
    });

    $('#table_data').on("select2:closing", function(){
        $('#table_num').empty();
        var table_data_name = $('#table_data option:selected').text();
        if (table_data_name == "accx" || table_data_name == "accy" || table_data_name == "accz"){
            $("#table_num").prop("disabled",false);
            for (var number = 0; number < 2; number++){
                var newOption = $('<option>' + number + '</option>');
                $('#table_num').append(newOption);
            }
        }
        else if (table_data_name == "it" || table_data_name == "et"){
            $("#table_num").prop("disabled",false);
            for (var number = 1; number < 16; number++){
                var newOption = $('<option>' + number + '</option>');
                $('#table_num').append(newOption);
            }
        }
        else if (table_data_name == "ssel" || table_data_name == "ssaz"){
            $("#table_num").prop("disabled",false);
            for (var number = 0; number < 4; number++){
                var newOption = $('<option>' + number + '</option>');
                $('#table_num').append(newOption);
            }
        }
        else{
            $("#table_num").prop("disabled",true);
        }

    });

    $('#table_data2').on("select2:closing", function(){
        $('#table_num2').empty();
        var table_data_name = $('#table_data2 option:selected').text();
        if (table_data_name == "accx" || table_data_name == "accy" || table_data_name == "accz"){
            $("#table_num2").prop("disabled",false);
            for (var number = 0; number < 2; number++){
                var newOption = $('<option>' + number + '</option>');
                $('#table_num2').append(newOption);
            }
        }
        else if (table_data_name == "it" || table_data_name == "et"){
            $("#table_num2").prop("disabled",false);
            for (var number = 1; number < 16; number++){
                var newOption = $('<option>' + number + '</option>');
                $('#table_num2').append(newOption);
            }
        }
        else if (table_data_name == "ssel" || table_data_name == "ssaz"){
            $("#table_num2").prop("disabled",false);
            for (var number = 0; number < 4; number++){
                var newOption = $('<option>' + number + '</option>');
                $('#table_num2').append(newOption);
            }
        }
        else{
            $("#table_num2").prop("disabled",true);
        }

    });

    $('#table_button').click( function(){
        if (sync_on){
            i=hk_nbufs.length-1;
            updatehtml_all(i);
        }else{
            {i=hk_nbufs.length-1; updatehtml_hk(hk_nbufs[i]);}
        }
        $.getJSON('/api/' + ip_db +  '/table_names', function(data) {
            table_list = data['tables']
        });
        setTimeout(function(){
            for (var table_count = 0; table_count < table_list.length; table_count++){
                if (table_list[table_count] == "{{table_selected}}"){
                    newOption = $('<option selected>' + table_list[table_count] + '</option>');
                    addmore = 0
                }else{
                    newOption = $('<option>' + table_list[table_count] + '</option>');
                }
                $('#table').append(newOption);
            }
            if(addmore){
                newOption = $('<option>' + "{{table_selected}}" + '</option>');
                $('#table').append(newOption);
            }
            NoneOption = $('<option selected>' + "None" + '</option>');
            $('#table').append(NoneOption);
        },1000);
        setTimeout(function(){
            for (var table_count = 0; table_count < table_list.length; table_count++){
                if (table_list[table_count] == "{{table_selected}}"){
                    newOption = $('<option selected>' + table_list[table_count] + '</option>');
                    addmore = 0
                }else{
                    newOption = $('<option>' + table_list[table_count] + '</option>');
                }
                $('#table2').append(newOption);
            }
            if(addmore){
                newOption = $('<option>' + "{{table_selected}}" + '</option>');
                $('#table2').append(newOption);
            }
            NoneOption = $('<option selected>' + "None" + '</option>');
            $('#table2').append(NoneOption);
        },1000);    
    });

    var sync_checkbox = $('#sync_checkbox')[0];
    var switchery_sync = new Switchery(sync_checkbox, { color: '#1AB394' });
    sync_checkbox.onchange = function() {
        if (sync_checkbox.checked) {
            sync_on = true;
           
        } else {
            sync_on = false;
        };
    };
    var auto_checkbox = $('#auto_checkbox')[0];
    var switchery_auto = new Switchery(auto_checkbox, { color: '#1AB394' });
    console.log(auto_checkbox);

    // switchery.disable();
    var myInterval;
    auto_checkbox.onchange = function() {
        if (auto_checkbox.checked) {
            myInterval = setInterval(function() {
                if (sync_on){
                   if (i<hk_nbufs.length-1) {
                       i=i+1;
                       updatehtml_all(i);
                   };
                }else{
                    if (i<hk_nbufs.length-1)        {i=i+1; updatehtml_hk(hk_nbufs[i]);}
                }
            }, 1000);
        } else {
            clearInterval(myInterval);
        };
    };

    $('#goto').click( function(){
       var keywords=parseInt($('#keywords').val());
       // console.log(keywords);
       if (sync_on){
            var index=hk_times.indexOf(keywords);
            if (index!=-1 && keywords){
               i=index;
               updatehtml_all(i);
            }else{
                swal({  title: 'HK Data not found!', type: "warning", timer: 3000, showConfirmButton: true});
            }
       }else{
            var message = '';
            var index=hk_times.indexOf(keywords);       if(index!=-1 && keywords) { i=index; updatehtml_hk(hk_nbufs[i]); message += 'HK ';}
            if (message == ''){
                swal({  title: 'No matched time found!', type: "warning", timer: 3000, showConfirmButton: true});
            }else{
                swal({  title: 'Matched '+message + 'time are found!', type: "success", timer: 3000, showConfirmButton: true});
            }

       }
    });
});
 </script>
 {% endblock %}